<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flip Cup AR</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #1a0a2e;
            overflow: hidden;
            font-family: 'Press Start 2P', monospace;
        }

        #game-container { position: relative; width: 100vw; height: 100vh; }
        #webcam { position: absolute; opacity: 0; pointer-events: none; }

        /* Screen Shake */
        .screen-shake { animation: shake 0.3s ease-out; }
        @keyframes shake {
            0%, 100% { transform: translate(0, 0); }
            20% { transform: translate(-10px, 5px); }
            40% { transform: translate(10px, -5px); }
            60% { transform: translate(-5px, 10px); }
            80% { transform: translate(5px, -10px); }
        }
        .screen-shake-big { animation: shakeBig 0.5s ease-out; }
        @keyframes shakeBig {
            0%, 100% { transform: translate(0, 0); }
            25% { transform: translate(-15px, 10px); }
            50% { transform: translate(15px, -10px); }
            75% { transform: translate(-10px, 5px); }
        }

        /* Glitch Effect */
        .glitch-effect { animation: glitch 0.4s ease-out; }
        @keyframes glitch {
            0% { filter: none; }
            25% { filter: hue-rotate(90deg) saturate(2); transform: translate(3px, 0); }
            50% { filter: hue-rotate(-90deg) saturate(2); transform: translate(-3px, 0); }
            75% { filter: hue-rotate(180deg) brightness(1.5); transform: translate(2px, -2px); }
            100% { filter: none; transform: translate(0, 0); }
        }

        /* Vaporwave Background */
        .vaporwave-bg {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(180deg,
                #0a0015 0%,
                #1a0a3a 30%,
                #2d1b69 50%,
                #4a2c7a 65%,
                #1a0a3a 80%,
                #0a0015 100%
            );
            overflow: hidden;
        }

        /* Ambient glow orbs */
        .vaporwave-bg::before {
            content: '';
            position: absolute;
            top: 20%; left: 30%;
            width: 400px; height: 400px;
            background: radial-gradient(circle, #ff00ff22 0%, transparent 70%);
            animation: float1 8s ease-in-out infinite;
        }
        .vaporwave-bg::after {
            content: '';
            position: absolute;
            top: 30%; right: 20%;
            width: 300px; height: 300px;
            background: radial-gradient(circle, #00ffff22 0%, transparent 70%);
            animation: float2 10s ease-in-out infinite;
        }
        @keyframes float1 {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(30px, -20px) scale(1.1); }
        }
        @keyframes float2 {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(-20px, 30px) scale(1.15); }
        }

        /* Neon grid floor */
        .grid-container {
            position: absolute;
            bottom: 0; left: 0;
            width: 100%; height: 45%;
            perspective: 500px;
            overflow: hidden;
        }
        .grid {
            position: absolute;
            bottom: 0; left: -50%;
            width: 200%; height: 300%;
            background-image:
                linear-gradient(to right, #ff00ff44 1px, transparent 1px),
                linear-gradient(to bottom, #00ffff44 1px, transparent 1px);
            background-size: 80px 80px;
            transform: rotateX(70deg);
            animation: gridMove 3s linear infinite;
        }
        .grid::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(180deg, transparent 0%, #0a001588 100%);
        }
        @keyframes gridMove {
            0% { transform: rotateX(70deg) translateY(0); }
            100% { transform: rotateX(70deg) translateY(80px); }
        }

        /* Horizon glow */
        .horizon-glow {
            position: absolute;
            bottom: 42%; left: 0;
            width: 100%; height: 120px;
            background: linear-gradient(180deg,
                transparent 0%,
                #ff00ff33 30%,
                #ff6b9d66 50%,
                #ff00ff33 70%,
                transparent 100%
            );
            filter: blur(20px);
        }

        /* Stars */
        .stars {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 60%;
            background-image:
                radial-gradient(2px 2px at 20px 30px, #fff, transparent),
                radial-gradient(2px 2px at 40px 70px, #ff6b9d, transparent),
                radial-gradient(1px 1px at 90px 40px, #fff, transparent),
                radial-gradient(2px 2px at 130px 80px, #00ffff, transparent),
                radial-gradient(1px 1px at 160px 30px, #fff, transparent),
                radial-gradient(2px 2px at 200px 60px, #ff00ff, transparent),
                radial-gradient(1px 1px at 250px 20px, #fff, transparent),
                radial-gradient(2px 2px at 300px 50px, #fff, transparent),
                radial-gradient(1px 1px at 350px 70px, #00ffff, transparent),
                radial-gradient(2px 2px at 400px 30px, #ff6b9d, transparent);
            background-size: 400px 100px;
            animation: twinkle 4s ease-in-out infinite;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        .sun, .sun-lines, .sun-line { display: none; }

        /* Confetti */
        .confetti-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 500;
            overflow: hidden;
        }
        .confetti {
            position: absolute;
            width: 10px; height: 10px;
            opacity: 0;
        }
        .confetti.active { animation: confettiFall 1.5s ease-out forwards; }
        @keyframes confettiFall {
            0% { opacity: 1; transform: translateY(0) rotate(0deg); }
            100% { opacity: 0; transform: translateY(400px) rotate(720deg); }
        }

        /* Drinking Prompt Overlay */
        #drinking-prompt {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            color: #ffcc00;
            text-shadow: 0 0 20px #ffcc00, 0 0 40px #ff6600, 4px 4px 0 #000;
            z-index: 600;
            opacity: 0;
            pointer-events: none;
            text-align: center;
            white-space: nowrap;
        }
        #drinking-prompt.show { animation: drinkPromptPop 2.5s ease-out forwards; }
        @keyframes drinkPromptPop {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.3); }
            15% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            25% { transform: translate(-50%, -50%) scale(1); }
            75% { opacity: 1; }
            100% { opacity: 0; transform: translate(-50%, -60%) scale(0.8); }
        }

        /* Challenge Card */
        #challenge-card {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1a0a3a, #2d1b4e);
            border: 4px solid #ff00ff;
            padding: 40px 60px;
            z-index: 550;
            opacity: 0;
            pointer-events: none;
            text-align: center;
            box-shadow: 0 0 50px #ff00ff88;
        }
        #challenge-card.show { animation: cardReveal 2s ease-out forwards; }
        @keyframes cardReveal {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0) rotateY(180deg); }
            30% { opacity: 1; transform: translate(-50%, -50%) scale(1.1) rotateY(0deg); }
            40% { transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
        #challenge-card .card-title { font-size: 16px; color: #888; margin-bottom: 20px; }
        #challenge-card .card-name { font-size: 36px; color: #00ffff; text-shadow: 0 0 20px #00ffff; margin-bottom: 15px; }
        #challenge-card .card-desc { font-size: 14px; color: #ff6b9d; }

        /* ============ SCREENS ============ */
        .screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }
        .screen.active { display: flex; }

        /* Landing Screen */
        #landing-screen .title {
            font-size: 80px;
            color: #00ffff;
            margin-bottom: 10px;
            text-shadow: 6px 6px 0 #ff00ff, 0 0 30px #00ffff, 0 0 60px #00ffff;
            letter-spacing: 10px;
        }
        #landing-screen .tagline {
            font-size: 16px;
            color: #ff6b9d;
            margin-bottom: 80px;
            text-shadow: 0 0 10px #ff6b9d;
            letter-spacing: 3px;
        }
        .big-btn {
            padding: 25px 80px;
            font-size: 24px;
            background: linear-gradient(180deg, #ff00ff, #ff6b9d);
            color: #fff;
            border: none;
            cursor: pointer;
            text-shadow: 3px 3px 0 #000;
            box-shadow: 0 0 40px #ff00ff55;
            font-family: 'Press Start 2P', monospace;
        }
        .big-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 60px #ff00ff88;
        }

        /* Instructions Screen */
        #instructions-screen .section-title {
            font-size: 32px;
            color: #00ffff;
            margin-bottom: 60px;
            text-shadow: 0 0 20px #00ffff;
        }
        .instruction-steps {
            display: flex;
            gap: 80px;
            margin-bottom: 60px;
        }
        .step-box {
            text-align: center;
            width: 200px;
        }
        .step-icon {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            background: rgba(0,0,0,0.6);
            border: 3px solid #ff00ff;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
        }
        .step-text {
            font-size: 14px;
            color: #fff;
            line-height: 1.6;
        }
        .step-text .highlight { color: #00ffff; }

        /* Setup Screen */
        #setup-screen .section-title {
            font-size: 28px;
            color: #00ffff;
            margin-bottom: 40px;
            text-shadow: 0 0 20px #00ffff;
        }
        .mode-select {
            display: flex;
            gap: 30px;
            margin-bottom: 50px;
        }
        .mode-btn {
            padding: 30px 40px;
            background: rgba(0,0,0,0.8);
            border: 4px solid #444;
            color: #888;
            cursor: pointer;
            min-width: 220px;
            text-align: center;
        }
        .mode-btn:hover, .mode-btn.selected {
            border-color: #00ffff;
            color: #00ffff;
            box-shadow: 0 0 30px #00ffff55;
        }
        .mode-btn.chaos-btn {
            border-color: #ff00ff;
            background: linear-gradient(135deg, rgba(255,0,255,0.2), rgba(0,255,255,0.2));
        }
        .mode-btn.chaos-btn:hover, .mode-btn.chaos-btn.selected {
            border-color: #ff00ff;
            color: #ff00ff;
            box-shadow: 0 0 40px #ff00ff88;
        }
        .mode-btn .mode-name { font-size: 18px; margin-bottom: 12px; }
        .mode-btn .mode-desc { font-size: 10px; color: #ff6b9d; line-height: 1.8; }

        .team-setup { display: flex; gap: 60px; margin-bottom: 50px; }
        .team-box {
            text-align: center;
            background: rgba(0,0,0,0.8);
            padding: 30px 50px;
            border: 3px solid #333;
        }
        .team-box.team-a { border-color: #ff6b9d; box-shadow: 0 0 20px #ff6b9d33; }
        .team-box.team-b { border-color: #00ffff; box-shadow: 0 0 20px #00ffff33; }
        .team-label { font-size: 20px; color: #fff; margin-bottom: 15px; }
        .team-a .team-label { color: #ff6b9d; text-shadow: 0 0 15px #ff6b9d; }
        .team-b .team-label { color: #00ffff; text-shadow: 0 0 15px #00ffff; }
        .player-count { display: flex; align-items: center; gap: 15px; }
        .player-count button {
            width: 45px; height: 45px; font-size: 24px; border: none;
            background: #333; color: #fff; cursor: pointer;
            font-family: 'Press Start 2P', monospace;
        }
        .player-count button:hover { background: #555; }
        .player-count .count { font-size: 40px; color: #fff; width: 60px; text-align: center; }

        .position-hint {
            font-size: 12px;
            color: #888;
            margin-bottom: 30px;
            max-width: 500px;
            text-align: center;
            line-height: 1.8;
        }
        .position-hint .highlight { color: #ffcc00; }

        /* ============ GAME SCREEN ============ */
        #game-screen {
            display: none;
            width: 100%;
            height: 100%;
        }
        #game-screen.active { display: block; }

        .game-header {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 40px;
            z-index: 10;
        }
        .mode-timer {
            font-size: 48px;
            color: #00ffff;
            text-shadow: 0 0 30px #00ffff;
        }
        .mode-timer.warning { color: #ff6600; text-shadow: 0 0 30px #ff6600; }
        .combo-display {
            font-size: 24px;
            color: #ff00ff;
            text-shadow: 0 0 20px #ff00ff;
        }

        .split-screen {
            display: flex;
            width: 100%;
            height: 100%;
        }
        .team-side {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px;
            position: relative;
        }
        .team-side.team-a { border-right: 4px solid #ff00ff55; }

        .team-header { font-size: 32px; font-weight: bold; margin-bottom: 15px; }
        .team-a .team-header { color: #ff6b9d; text-shadow: 0 0 25px #ff6b9d; }
        .team-b .team-header { color: #00ffff; text-shadow: 0 0 25px #00ffff; }

        .player-indicators { display: flex; gap: 12px; margin-bottom: 20px; }
        .player-dot {
            width: 35px; height: 35px; border-radius: 50%;
            background: #333; border: 4px solid #666;
        }
        .player-dot.done { background: #00ff00; border-color: #00ff00; box-shadow: 0 0 20px #00ff00; }
        .player-dot.active { background: #ffcc00; border-color: #ffcc00; box-shadow: 0 0 25px #ffcc00; }

        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        .status-message {
            font-size: 36px;
            font-weight: bold;
            color: #fff;
            text-align: center;
            text-shadow: 0 0 25px currentColor;
            margin-bottom: 15px;
            min-height: 55px;
        }
        .status-message.drink { color: #ffcc00; }
        .status-message.ready { color: #00ffff; }

        .player-state {
            font-size: 12px;
            color: #ff6b9d;
            background: transparent;
            padding: 8px 20px;
            margin-bottom: 12px;
            border: 2px solid #ff6b9d44;
            border-radius: 20px;
            text-shadow: 0 0 10px #ff6b9d;
            letter-spacing: 1px;
        }
        .player-state.raised {
            color: #00ffff;
            border-color: #00ffff;
            text-shadow: 0 0 15px #00ffff;
            box-shadow: 0 0 20px #00ffff55;
        }

        .challenge-indicator {
            font-size: 12px;
            color: #ff00ff;
            background: rgba(0,0,0,0.8);
            padding: 6px 16px;
            margin-bottom: 12px;
            border: 2px solid #ff00ff;
            text-shadow: 0 0 8px #ff00ff;
        }

        /* Shot Meter */
        .meter-container {
            width: 90%;
            max-width: 350px;
            height: 40px;
            background: #111;
            position: relative;
            overflow: hidden;
            border: 4px solid #00ffff;
            margin-bottom: 20px;
            display: none;
            box-shadow: 0 0 20px #00ffff55;
        }
        .meter-container.wobble {
            animation: meterWobble var(--wobble-speed, 0.5s) ease-in-out infinite;
        }
        @keyframes meterWobble {
            0%, 100% { transform: translateX(var(--wobble-amount, 0px)) rotate(var(--wobble-rotate, 0deg)); }
            50% { transform: translateX(calc(var(--wobble-amount, 0px) * -1)) rotate(calc(var(--wobble-rotate, 0deg) * -1)); }
        }
        .meter-container.blindfold .meter-zones,
        .meter-container.blindfold .meter-needle { opacity: 0; }
        .meter-container.blindfold::after {
            content: '???';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 22px;
            color: #ff00ff;
        }

        .meter-zones {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex;
        }
        .meter-zone { height: 100%; }
        .meter-zone.red-left { background: #aa0000; flex: 2; }
        .meter-zone.yellow-left { background: #aa8800; flex: 1.5; }
        .meter-zone.green { background: #00aa00; flex: 1.25; }
        .meter-zone.sweet-spot { background: #00ff00; flex: 0.5; box-shadow: inset 0 0 15px #fff; }
        .meter-zone.green-right { background: #00aa00; flex: 1.25; }
        .meter-zone.yellow-right { background: #aa8800; flex: 1.5; }
        .meter-zone.red-right { background: #aa0000; flex: 2; }

        .meter-needle {
            position: absolute;
            top: -6px; bottom: -6px;
            width: 8px;
            background: #fff;
            border: 2px solid #000;
            transform: translateX(-50%);
            box-shadow: 0 0 15px #fff;
        }

        /* Cup Area */
        .cup-area {
            width: 100%;
            max-width: 300px;
            height: 180px;
            position: relative;
        }
        .bar-surface {
            position: absolute;
            bottom: 0; left: 0;
            width: 100%; height: 40px;
            background: linear-gradient(180deg, #4a3728 0%, #2a1a10 100%);
            border: 4px solid #1a0a05;
            box-shadow: 0 0 25px rgba(0,0,0,0.5);
        }
        .cup {
            position: absolute;
            bottom: 35px; left: 50%;
            width: 60px; height: 85px;
            transform: translateX(-50%);
            transition: transform 0.3s ease;
        }
        .cup-body { fill: #ff0044; stroke: #aa0033; stroke-width: 2; }
        .cup-rim { fill: #ff3366; }
        .cup-shine { fill: rgba(255,255,255,0.3); }
        .cup-beer { fill: #ffaa00; }
        .cup.on-edge { transform: translateX(-50%) translateX(40px); }
        .cup.flipped { transform: translateX(-50%) rotate(180deg); bottom: 38px; }
        .cup.fallen { transform: translateX(-50%) rotate(90deg) translateY(15px); bottom: 50px; }

        /* Feedback Flash */
        .feedback-flash {
            position: absolute;
            top: 45%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 52px;
            font-weight: bold;
            pointer-events: none;
            opacity: 0;
            z-index: 50;
        }
        .feedback-flash.show { animation: feedbackPop 1.2s ease-out forwards; }
        @keyframes feedbackPop {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.3); }
            40% { transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -60%) scale(1); }
        }
        .feedback-flash.perfect { color: #00ff00; text-shadow: 0 0 40px #00ff00, 0 0 80px #00ff00; }
        .feedback-flash.clean { color: #00ffaa; text-shadow: 0 0 40px #00ffaa; }
        .feedback-flash.sloppy { color: #ffaa00; text-shadow: 0 0 40px #ffaa00; }
        .feedback-flash.lucky { color: #ff00ff; text-shadow: 0 0 40px #ff00ff; }
        .feedback-flash.choke { color: #ff0000; text-shadow: 0 0 40px #ff0000; }
        .feedback-flash.pathetic { color: #ff0044; text-shadow: 0 0 40px #ff0044; }
        .feedback-flash.clutch { color: #ffcc00; text-shadow: 0 0 50px #ffcc00, 0 0 100px #ff6600; }

        .result-flash {
            font-size: 28px;
            font-weight: bold;
            text-shadow: 0 0 20px currentColor;
            min-height: 40px;
            margin-top: 5px;
        }
        .result-flash.success { color: #00ff00; }
        .result-flash.fail { color: #ff0000; }

        .attempt-counter { font-size: 11px; color: #aaa; margin-top: 5px; }
        .flip-count { font-size: 14px; color: #ffcc00; text-shadow: 0 0 15px #ffcc00; margin-top: 10px; }

        /* Webcam Preview - Bottom Right */
        #webcam-area {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }
        #webcam-preview {
            width: 320px;
            height: 180px;
            border: 4px solid #00ffff;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 0 25px #00ffff55, 0 0 50px #ff00ff33;
        }
        #webcam-preview video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transform: scaleX(-1);
            background: #000;
        }
        .zone-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            display: flex;
        }
        .zone-left, .zone-right {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: rgba(255,255,255,0.3);
        }
        .zone-left { border-right: 2px dashed rgba(255,107,157,0.5); }
        .zone-right { border-left: 2px dashed rgba(0,255,255,0.5); }
        .hand-indicator {
            position: absolute;
            width: 35px; height: 35px;
            border-radius: 50%;
            border: 4px solid #fff;
            pointer-events: none;
            display: none;
            transform: translate(-50%, -50%);
        }
        #hand-left { background: rgba(255, 107, 157, 0.8); box-shadow: 0 0 20px #ff6b9d; }
        #hand-right { background: rgba(0, 255, 255, 0.8); box-shadow: 0 0 20px #00ffff; }
        .gesture-label {
            position: absolute;
            bottom: -28px; left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #fff;
            white-space: nowrap;
            background: rgba(0,0,0,0.9);
            padding: 3px 10px;
            border-radius: 10px;
        }

        /* Win Screen */
        #win-screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 300;
        }
        .winner-text { font-size: 56px; font-weight: bold; margin-bottom: 20px; }
        .winner-text.team-a { color: #ff6b9d; text-shadow: 0 0 50px #ff6b9d; }
        .winner-text.team-b { color: #00ffff; text-shadow: 0 0 50px #00ffff; }
        .loser-text { font-size: 24px; color: #ffcc00; margin-bottom: 40px; text-shadow: 0 0 20px #ffcc00; }
        .final-stats {
            background: rgba(0,0,0,0.8);
            border: 4px solid #ff00ff;
            padding: 30px 50px;
            margin-bottom: 30px;
            text-align: center;
        }
        .stat-line { font-size: 14px; color: #fff; margin: 12px 0; }
        .stat-value { color: #00ffff; }
        #play-again-btn {
            padding: 20px 50px;
            font-size: 18px;
            background: linear-gradient(180deg, #00ffff, #0088aa);
            color: #000;
            border: none;
            cursor: pointer;
            font-family: 'Press Start 2P', monospace;
            box-shadow: 0 0 40px #00ffff55;
        }

        #loading {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
            color: #00ffff;
            z-index: 400;
            background: #0a0015;
            padding: 30px 50px;
            border: 4px solid #ff00ff;
            text-shadow: 0 0 15px #00ffff;
            box-shadow: 0 0 40px #ff00ff55;
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="game-container">
        <video id="webcam" autoplay playsinline></video>

        <!-- Vaporwave Background -->
        <div class="vaporwave-bg">
            <div class="stars"></div>
            <div class="horizon-glow"></div>
            <div class="grid-container">
                <div class="grid"></div>
            </div>
        </div>

        <!-- Confetti Container -->
        <div class="confetti-container" id="confetti-container"></div>

        <!-- Drinking Prompt -->
        <div id="drinking-prompt"></div>

        <!-- Challenge Card -->
        <div id="challenge-card">
            <div class="card-title">CHALLENGE CARD</div>
            <div class="card-name" id="card-name">BLINDFOLD</div>
            <div class="card-desc" id="card-desc">Meter is hidden!</div>
        </div>

        <!-- ============ LANDING SCREEN ============ -->
        <div id="landing-screen" class="screen active">
            <div class="title">FLIP CUP</div>
            <div class="tagline">you're gonna embarrass yourself</div>
            <button class="big-btn" onclick="showScreen('instructions')">START</button>
        </div>

        <!-- ============ INSTRUCTIONS SCREEN ============ -->
        <div id="instructions-screen" class="screen">
            <div class="section-title">HOW TO PLAY</div>
            <div class="instruction-steps">
                <div class="step-box">
                    <div class="step-icon">üç∫</div>
                    <div class="step-text"><span class="highlight">1.</span> DRINK YOUR CUP<br>(for real)</div>
                </div>
                <div class="step-box">
                    <div class="step-icon">‚úã</div>
                    <div class="step-text"><span class="highlight">2.</span> RAISE HAND<br>(when ready)</div>
                </div>
                <div class="step-box">
                    <div class="step-icon">
                        <svg viewBox="0 0 64 64" width="60" height="60">
                            <!-- Open palm facing up -->
                            <path d="M32,58 C22,58 16,52 16,44 L16,32 C16,28 18,26 22,26 L22,22 C22,19 24,17 27,17 C27,14 29,12 32,12 C35,12 37,14 37,17 C40,17 42,19 42,22 L42,26 C46,26 48,28 48,32 L48,44 C48,52 42,58 32,58 Z"
                                  fill="#00ffff" stroke="#fff" stroke-width="2"/>
                            <!-- Finger lines -->
                            <line x1="27" y1="26" x2="27" y2="38" stroke="#0088aa" stroke-width="1.5" stroke-linecap="round"/>
                            <line x1="32" y1="22" x2="32" y2="38" stroke="#0088aa" stroke-width="1.5" stroke-linecap="round"/>
                            <line x1="37" y1="26" x2="37" y2="38" stroke="#0088aa" stroke-width="1.5" stroke-linecap="round"/>
                            <!-- Upward arrow -->
                            <path d="M32,2 L38,10 L34,10 L34,18 L30,18 L30,10 L26,10 Z"
                                  fill="#ff00ff" stroke="#fff" stroke-width="1"/>
                        </svg>
                    </div>
                    <div class="step-text"><span class="highlight">3.</span> FLICK UP<br>(hit the sweet spot)</div>
                </div>
            </div>
            <button class="big-btn" onclick="showScreen('setup')">GOT IT</button>
        </div>

        <!-- ============ SETUP SCREEN ============ -->
        <div id="setup-screen" class="screen">
            <div class="section-title">PICK YOUR POISON</div>

            <div class="mode-select">
                <button class="mode-btn selected" data-mode="classic">
                    <div class="mode-name">CLASSIC</div>
                    <div class="mode-desc">RELAY RACE<br>5 FLIPS EACH</div>
                </button>
                <button class="mode-btn chaos-btn" data-mode="chaos">
                    <div class="mode-name">CHAOS</div>
                    <div class="mode-desc">FULL SEND<br>ALL MODIFIERS</div>
                </button>
            </div>

            <div class="team-setup">
                <div class="team-box team-a">
                    <div class="team-label">TEAM A</div>
                    <div class="player-count">
                        <button onclick="adjustTeam('a', -1)">-</button>
                        <span class="count" id="team-a-count">2</span>
                        <button onclick="adjustTeam('a', 1)">+</button>
                    </div>
                </div>
                <div class="team-box team-b">
                    <div class="team-label">TEAM B</div>
                    <div class="player-count">
                        <button onclick="adjustTeam('b', -1)">-</button>
                        <span class="count" id="team-b-count">2</span>
                        <button onclick="adjustTeam('b', 1)">+</button>
                    </div>
                </div>
            </div>

            <div class="position-hint">
                <span class="highlight">TEAM A</span> stand on LEFT side of camera<br>
                <span class="highlight">TEAM B</span> stand on RIGHT side of camera
            </div>

            <button class="big-btn" onclick="startGame()">LET'S GO</button>
        </div>

        <!-- ============ GAME SCREEN ============ -->
        <div id="game-screen">
            <div class="game-header hidden" id="game-header">
                <div class="mode-timer" id="mode-timer">60</div>
                <div class="combo-display" id="combo-display"></div>
            </div>

            <div class="split-screen">
                <!-- Team A Side -->
                <div class="team-side team-a">
                    <div class="team-header">TEAM A</div>
                    <div class="player-indicators" id="team-a-indicators"></div>
                    <div class="game-area">
                        <div class="status-message" id="status-a"></div>
                        <div class="challenge-indicator hidden" id="challenge-a"></div>
                        <div class="player-state" id="state-a">Waiting...</div>
                        <div class="meter-container" id="meter-a">
                            <div class="meter-zones" id="zones-a">
                                <div class="meter-zone red-left"></div>
                                <div class="meter-zone yellow-left"></div>
                                <div class="meter-zone green"></div>
                                <div class="meter-zone sweet-spot"></div>
                                <div class="meter-zone green-right"></div>
                                <div class="meter-zone yellow-right"></div>
                                <div class="meter-zone red-right"></div>
                            </div>
                            <div class="meter-needle" id="needle-a" style="left: 50%"></div>
                        </div>
                        <div class="cup-area">
                            <div class="cup" id="cup-a">
                                <svg viewBox="0 0 60 85" width="60" height="85">
                                    <path class="cup-body" d="M6,6 L54,6 L48,76 Q48,82 30,82 Q12,82 12,76 Z"/>
                                    <rect class="cup-rim" x="4" y="0" width="52" height="9" rx="2"/>
                                    <ellipse class="cup-beer" cx="30" cy="24" rx="17" ry="9"/>
                                    <ellipse class="cup-shine" cx="19" cy="18" rx="6" ry="4"/>
                                </svg>
                            </div>
                            <div class="bar-surface"></div>
                        </div>
                        <div class="result-flash" id="result-a"></div>
                        <div class="attempt-counter" id="attempts-a"></div>
                        <div class="flip-count" id="flips-a"></div>
                    </div>
                    <div class="feedback-flash" id="feedback-a"></div>
                </div>

                <!-- Team B Side -->
                <div class="team-side team-b">
                    <div class="team-header">TEAM B</div>
                    <div class="player-indicators" id="team-b-indicators"></div>
                    <div class="game-area">
                        <div class="status-message" id="status-b"></div>
                        <div class="challenge-indicator hidden" id="challenge-b"></div>
                        <div class="player-state" id="state-b">Waiting...</div>
                        <div class="meter-container" id="meter-b">
                            <div class="meter-zones" id="zones-b">
                                <div class="meter-zone red-left"></div>
                                <div class="meter-zone yellow-left"></div>
                                <div class="meter-zone green"></div>
                                <div class="meter-zone sweet-spot"></div>
                                <div class="meter-zone green-right"></div>
                                <div class="meter-zone yellow-right"></div>
                                <div class="meter-zone red-right"></div>
                            </div>
                            <div class="meter-needle" id="needle-b" style="left: 50%"></div>
                        </div>
                        <div class="cup-area">
                            <div class="cup" id="cup-b">
                                <svg viewBox="0 0 60 85" width="60" height="85">
                                    <path class="cup-body" d="M6,6 L54,6 L48,76 Q48,82 30,82 Q12,82 12,76 Z"/>
                                    <rect class="cup-rim" x="4" y="0" width="52" height="9" rx="2"/>
                                    <ellipse class="cup-beer" cx="30" cy="24" rx="17" ry="9"/>
                                    <ellipse class="cup-shine" cx="19" cy="18" rx="6" ry="4"/>
                                </svg>
                            </div>
                            <div class="bar-surface"></div>
                        </div>
                        <div class="result-flash" id="result-b"></div>
                        <div class="attempt-counter" id="attempts-b"></div>
                        <div class="flip-count" id="flips-b"></div>
                    </div>
                    <div class="feedback-flash" id="feedback-b"></div>
                </div>
            </div>

            <!-- Webcam Area - Bottom Right -->
            <div id="webcam-area">
                <div id="webcam-preview">
                    <video id="preview-video" autoplay playsinline muted></video>
                    <div class="zone-overlay">
                        <div class="zone-left">A</div>
                        <div class="zone-right">B</div>
                    </div>
                    <div class="hand-indicator" id="hand-left">
                        <span class="gesture-label" id="gesture-left"></span>
                    </div>
                    <div class="hand-indicator" id="hand-right">
                        <span class="gesture-label" id="gesture-right"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Win Screen -->
        <div id="win-screen">
            <div class="winner-text" id="winner-text">TEAM A WINS!</div>
            <div class="loser-text" id="loser-text">LOSERS DRINK UP!</div>
            <div class="final-stats" id="final-stats">
                <p class="stat-line">TOTAL FLIPS: <span class="stat-value" id="stat-flips">0</span></p>
                <p class="stat-line">BEST COMBO: <span class="stat-value" id="stat-combo">0</span></p>
                <p class="stat-line">DRINKS OWED: <span class="stat-value" id="stat-drinks">0</span></p>
            </div>
            <button id="play-again-btn" onclick="resetGame()">PLAY AGAIN</button>
        </div>

        <div id="loading">LOADING CAMERA...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>

    <script>
        const video = document.getElementById('webcam');
        const previewVideo = document.getElementById('preview-video');

        // ============ SCREEN NAVIGATION ============
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const target = document.getElementById(screenId + '-screen');
            if (target) target.classList.add('active');
        }

        // ============ CHALLENGE CARDS ============
        const challengeCards = {
            blindfold: { name: 'BLINDFOLD', desc: 'Meter is hidden!', effect: 'blindfold' },
            pressure: { name: 'PRESSURE', desc: 'Only 1 attempt!', effect: 'pressure' },
            speed: { name: 'SPEED', desc: '2x meter speed!', effect: 'speed' },
            reverse: { name: 'REVERSE', desc: 'Random direction changes!', effect: 'reverse' },
            drunk: { name: 'EXTRA DRUNK', desc: 'Maximum wobble!', effect: 'drunk' },
            precision: { name: 'PRECISION', desc: 'Only sweet spot counts!', effect: 'precision' }
        };
        const cardKeys = Object.keys(challengeCards);

        // ============ DRINKING RULES ============
        const drinkingPrompts = {
            chokeTax: "CHOKE TAX!",
            mercyShame: "MERCY SHAME!",
            comboBreaker: "COMBO BREAKER!",
            luckyBastard: "LUCKY! THEY DRINK!",
            patheticTax: "PATHETIC TAX!",
            wrongCallout: "WRONG CALL!",
            perfectBonus: "CALLED IT! +500"
        };

        // ============ GAME CONFIG ============
        const configs = {
            classic: {
                flipsPerPlayer: 5,
                baseMeterSpeed: 1.2,
                meterSpeedIncrease: 0.15,
                wobbleEnabled: false,
                shrinkingZones: false,
                challengeCards: false,
                maxAttempts: 5,
                timed: false
            },
            chaos: {
                flipsPerPlayer: 3,
                baseMeterSpeed: 1.5,
                meterSpeedIncrease: 0.2,
                wobbleEnabled: true,
                wobbleBase: 5,
                wobbleIncrease: 5,
                shrinkingZones: true,
                shrinkFactor: 0.12,
                challengeCards: true,
                maxAttempts: 3,
                timed: true,
                timeLimit: 60
            }
        };

        // Zone config - sweet spot is guaranteed success
        const zoneConfig = {
            sweetSpotChance: 1.0,
            greenChance: 0.75,
            yellowChance: 0.40,
            redChance: 0.15
        };

        // ============ GAME STATE ============
        const game = {
            mode: 'classic',
            config: configs.classic,
            teamACount: 2,
            teamBCount: 2,
            teams: { a: createTeamState(), b: createTeamState() },
            started: false,
            timeLeft: 60,
            startTime: 0,
            globalCombo: 0,
            globalBestCombo: 0,
            totalDrinks: 0,
            roundNumber: 0,
            trackedHands: { a: null, b: null } // Track specific hands per team
        };

        function createTeamState() {
            return {
                progress: 0,
                phase: 'waiting',
                meterPos: 50,
                meterDir: 1,
                attempts: 0,
                handRaised: false,
                flips: 0,
                combo: 0,
                bestCombo: 0,
                currentFlip: 0,
                challengeCard: null,
                reverseTimer: 0,
                lastFlickY: 0,
                lastFlickTime: 0  // Cooldown to prevent double-triggers
            };
        }

        // ============ FEEDBACK MESSAGES ============
        const feedback = {
            perfect: 'PERFECT!',
            clean: 'CLEAN!',
            sloppy: 'SLOPPY!',
            lucky: 'LUCKY!',
            choke: 'CHOKE!',
            pathetic: 'PATHETIC!',
            clutch: 'CLUTCH!'
        };

        // ============ MODE SELECTION ============
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                game.mode = btn.dataset.mode;
                game.config = configs[game.mode];
            });
        });

        // ============ TEAM SETUP ============
        function adjustTeam(team, delta) {
            if (team === 'a') {
                game.teamACount = Math.max(1, Math.min(4, game.teamACount + delta));
                document.getElementById('team-a-count').textContent = game.teamACount;
            } else {
                game.teamBCount = Math.max(1, Math.min(4, game.teamBCount + delta));
                document.getElementById('team-b-count').textContent = game.teamBCount;
            }
        }

        function createPlayerIndicators() {
            ['a', 'b'].forEach(team => {
                const container = document.getElementById(`team-${team}-indicators`);
                const count = team === 'a' ? game.teamACount : game.teamBCount;
                container.innerHTML = '';
                for (let i = 0; i < count; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'player-dot' + (i === 0 ? ' active' : '');
                    dot.id = `dot-${team}-${i}`;
                    container.appendChild(dot);
                }
            });
        }

        // ============ VISUAL EFFECTS ============
        function triggerScreenShake(big = false) {
            const container = document.getElementById('game-container');
            container.classList.remove('screen-shake', 'screen-shake-big');
            void container.offsetWidth;
            container.classList.add(big ? 'screen-shake-big' : 'screen-shake');
            setTimeout(() => container.classList.remove('screen-shake', 'screen-shake-big'), big ? 500 : 300);
        }

        function triggerGlitch() {
            const container = document.getElementById('game-container');
            container.classList.remove('glitch-effect');
            void container.offsetWidth;
            container.classList.add('glitch-effect');
            setTimeout(() => container.classList.remove('glitch-effect'), 400);
        }

        function spawnConfetti(x, y, count = 30) {
            const container = document.getElementById('confetti-container');
            const colors = ['#ff00ff', '#00ffff', '#ffcc00', '#00ff00', '#ff6b9d', '#fff'];

            for (let i = 0; i < count; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = (x + (Math.random() - 0.5) * 100) + 'px';
                confetti.style.top = y + 'px';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                confetti.style.animationDelay = (Math.random() * 0.3) + 's';
                confetti.style.animationDuration = (1 + Math.random() * 0.5) + 's';
                container.appendChild(confetti);

                setTimeout(() => confetti.classList.add('active'), 10);
                setTimeout(() => confetti.remove(), 2000);
            }
        }

        function showDrinkingPrompt(promptKey) {
            const el = document.getElementById('drinking-prompt');
            el.textContent = drinkingPrompts[promptKey];
            el.classList.remove('show');
            void el.offsetWidth;
            el.classList.add('show');

            if (promptKey !== 'perfectBonus') {
                game.totalDrinks++;
            }
            setTimeout(() => el.classList.remove('show'), 2500);
        }

        function showChallengeCard(team, cardKey) {
            const card = challengeCards[cardKey];
            document.getElementById('card-name').textContent = card.name;
            document.getElementById('card-desc').textContent = card.desc;

            const cardEl = document.getElementById('challenge-card');
            cardEl.classList.remove('show');
            void cardEl.offsetWidth;
            cardEl.classList.add('show');

            const indicator = document.getElementById(`challenge-${team}`);
            indicator.textContent = card.name;
            indicator.classList.remove('hidden');
        }

        function showFeedback(team, type) {
            const el = document.getElementById(`feedback-${team}`);
            el.textContent = feedback[type];
            el.className = `feedback-flash ${type} show`;
            setTimeout(() => el.classList.remove('show'), 1200);
        }

        // ============ METER WOBBLE ============
        function updateMeterWobble(team) {
            if (!game.config.wobbleEnabled) return;

            const meter = document.getElementById(`meter-${team}`);
            const t = game.teams[team];

            let wobbleAmount = game.config.wobbleBase + (game.roundNumber * game.config.wobbleIncrease);
            let wobbleSpeed = 0.4 - (game.roundNumber * 0.05);
            wobbleSpeed = Math.max(0.2, wobbleSpeed);

            if (t.challengeCard === 'drunk') {
                wobbleAmount *= 2;
                wobbleSpeed *= 0.7;
            }

            meter.style.setProperty('--wobble-amount', wobbleAmount + 'px');
            meter.style.setProperty('--wobble-rotate', (wobbleAmount / 3) + 'deg');
            meter.style.setProperty('--wobble-speed', wobbleSpeed + 's');
            meter.classList.add('wobble');
        }

        // ============ GAME FLOW ============
        function startGame() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('game-screen').classList.add('active');

            game.config = configs[game.mode];
            game.teams.a = createTeamState();
            game.teams.b = createTeamState();
            game.started = true;
            game.timeLeft = game.config.timeLimit || 60;
            game.startTime = Date.now();
            game.globalCombo = 0;
            game.globalBestCombo = 0;
            game.totalDrinks = 0;
            game.roundNumber = 0;
            game.trackedHands = { a: null, b: null };

            createPlayerIndicators();

            // Show timer for chaos mode
            const header = document.getElementById('game-header');
            if (game.config.timed) {
                header.classList.remove('hidden');
            } else {
                header.classList.add('hidden');
            }

            startDrinkPhase('a');
            startDrinkPhase('b');

            requestAnimationFrame(gameLoop);
        }

        function getMeterSpeed(team) {
            const t = game.teams[team];
            let speed = game.config.baseMeterSpeed + (t.progress * game.config.meterSpeedIncrease);
            if (t.challengeCard === 'speed') speed *= 2;
            return speed;
        }

        function startDrinkPhase(team) {
            const t = game.teams[team];

            t.phase = 'drink';
            t.handRaised = false;
            t.attempts = 0;
            t.challengeCard = null;
            t.reverseTimer = 0;

            document.getElementById(`challenge-${team}`).classList.add('hidden');

            updateStatus(team, 'DRINK & RAISE', 'drink');
            updateState(team, 'Raise hand when ready', '');
            updateAttempts(team, '');

            const cup = document.getElementById(`cup-${team}`);
            cup.className = 'cup';

            const meter = document.getElementById(`meter-${team}`);
            meter.style.display = 'none';
            meter.classList.remove('wobble', 'blindfold');

            document.getElementById(`result-${team}`).textContent = '';

            // Update flip counter
            if (game.config.timed) {
                document.getElementById(`flips-${team}`).textContent = `FLIPS: ${t.flips}`;
            } else {
                document.getElementById(`flips-${team}`).textContent = `${t.currentFlip}/${game.config.flipsPerPlayer}`;
            }
        }

        function onHandRaised(team) {
            const t = game.teams[team];
            if (t.handRaised) return;

            t.handRaised = true;
            updateState(team, 'READY!', 'raised');

            // Assign challenge card in chaos mode
            if (game.config.challengeCards) {
                const cardKey = cardKeys[Math.floor(Math.random() * cardKeys.length)];
                t.challengeCard = challengeCards[cardKey].effect;
                showChallengeCard(team, cardKey);
                setTimeout(() => startFlipPhase(team), 2000);
            } else {
                startFlipPhase(team);
            }
        }

        function startFlipPhase(team) {
            const t = game.teams[team];
            t.phase = 'countdown';

            updateStatus(team, 'GET READY', '');
            updateState(team, '', '');

            document.getElementById(`cup-${team}`).className = 'cup on-edge';

            setTimeout(() => updateStatus(team, '3', ''), 400);
            setTimeout(() => updateStatus(team, '2', ''), 800);
            setTimeout(() => updateStatus(team, '1', ''), 1200);
            setTimeout(() => {
                t.phase = 'flip';
                t.meterPos = 50;
                t.meterDir = Math.random() > 0.5 ? 1 : -1;

                if (t.challengeCard === 'reverse') {
                    t.reverseTimer = 30 + Math.random() * 60;
                }

                updateStatus(team, 'FLICK!', 'ready');
                updateState(team, 'Flick UP now!', '');

                const meter = document.getElementById(`meter-${team}`);
                meter.style.display = 'block';

                if (t.challengeCard === 'blindfold') {
                    meter.classList.add('blindfold');
                }

                updateMeterWobble(team);

                const maxAttempts = t.challengeCard === 'pressure' ? 1 : game.config.maxAttempts;
                updateAttempts(team, `Attempt ${t.attempts + 1}/${maxAttempts}`);
            }, 1600);
        }

        function updateStatus(team, text, className) {
            const el = document.getElementById(`status-${team}`);
            el.textContent = text;
            el.className = 'status-message' + (className ? ` ${className}` : '');
        }

        function updateState(team, text, className) {
            const el = document.getElementById(`state-${team}`);
            el.textContent = text;
            el.className = 'player-state' + (className ? ` ${className}` : '');
        }

        function updateAttempts(team, text) {
            document.getElementById(`attempts-${team}`).textContent = text;
        }

        // ============ GAME LOOP ============
        function gameLoop() {
            if (!game.started) return;

            // Timer for chaos mode
            if (game.config.timed) {
                game.timeLeft = game.config.timeLimit - (Date.now() - game.startTime) / 1000;
                const timerEl = document.getElementById('mode-timer');
                timerEl.textContent = Math.ceil(Math.max(0, game.timeLeft));
                timerEl.className = game.timeLeft < 10 ? 'mode-timer warning' : 'mode-timer';

                document.getElementById('combo-display').textContent = game.globalCombo > 0 ? `${game.globalCombo}x COMBO` : '';

                if (game.timeLeft <= 0) {
                    endGame();
                    return;
                }
            }

            // Update meters
            ['a', 'b'].forEach(team => {
                const t = game.teams[team];
                if (t.phase === 'flip') {
                    const speed = getMeterSpeed(team);
                    t.meterPos += t.meterDir * speed;

                    if (t.challengeCard === 'reverse') {
                        t.reverseTimer--;
                        if (t.reverseTimer <= 0) {
                            t.meterDir *= -1;
                            t.reverseTimer = 20 + Math.random() * 40;
                        }
                    }

                    if (t.meterPos >= 100) { t.meterPos = 100; t.meterDir = -1; }
                    if (t.meterPos <= 0) { t.meterPos = 0; t.meterDir = 1; }

                    document.getElementById(`needle-${team}`).style.left = t.meterPos + '%';
                }
            });

            requestAnimationFrame(gameLoop);
        }

        // ============ HAND DETECTION (FIXED) ============
        function onHandResults(results) {
            // Reset indicators
            document.getElementById('hand-left').style.display = 'none';
            document.getElementById('hand-right').style.display = 'none';

            if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
                return;
            }

            // Collect all detected hands with their positions
            const detectedHands = [];

            results.multiHandLandmarks.forEach((landmarks, idx) => {
                const wrist = landmarks[0];
                const indexTip = landmarks[8];

                // Get handedness if available
                const handedness = results.multiHandedness && results.multiHandedness[idx]
                    ? results.multiHandedness[idx].label
                    : null;

                detectedHands.push({
                    wrist,
                    indexTip,
                    handedness,
                    x: wrist.x,
                    y: wrist.y
                });
            });

            // Assign hands to teams based on screen position
            // Team A = LEFT side of camera (right side of mirrored preview, x < 0.5)
            // Team B = RIGHT side of camera (left side of mirrored preview, x > 0.5)

            // Find best hand for each side (closest to that side's edge)
            let teamAHand = null;
            let teamBHand = null;

            detectedHands.forEach(hand => {
                // Hand in left half of camera (Team A zone)
                if (hand.x < 0.5) {
                    if (!teamAHand || hand.x < teamAHand.x) {
                        teamAHand = hand;
                    }
                }
                // Hand in right half of camera (Team B zone)
                else {
                    if (!teamBHand || hand.x > teamBHand.x) {
                        teamBHand = hand;
                    }
                }
            });

            // Process Team A hand
            if (teamAHand) {
                processHand('a', teamAHand, 'left');
            }

            // Process Team B hand
            if (teamBHand) {
                processHand('b', teamBHand, 'right');
            }
        }

        function processHand(team, hand, indicatorSide) {
            const t = game.teams[team];

            // Update indicator position (mirrored for preview)
            const indicator = document.getElementById(`hand-${indicatorSide}`);
            indicator.style.display = 'block';
            indicator.style.left = ((1 - hand.x) * 320) + 'px';
            indicator.style.top = (hand.y * 180) + 'px';

            const isRaised = hand.wrist.y < 0.35;

            // Calculate flick velocity
            const flickVelocity = (t.lastFlickY || hand.wrist.y) - hand.indexTip.y;
            const isFlicking = flickVelocity > 0.06;
            t.lastFlickY = hand.indexTip.y;

            // Update gesture label
            let gestureText = '';
            if (isRaised) gestureText = 'RAISED';
            else if (isFlicking) gestureText = 'FLICK!';
            document.getElementById(`gesture-${indicatorSide}`).textContent = gestureText;

            // Handle game actions
            if (t.phase === 'drink' && isRaised && !t.handRaised) {
                onHandRaised(team);
            }

            // Flick with cooldown (500ms) to prevent double-triggers
            const now = Date.now();
            if (t.phase === 'flip' && isFlicking && (now - t.lastFlickTime > 500)) {
                t.lastFlickTime = now;
                handleFlip(team);
            }
        }

        function handleFlip(team) {
            const t = game.teams[team];
            if (t.phase !== 'flip') return;

            t.phase = 'animating';
            t.attempts++;

            const pos = t.meterPos;
            let successChance;
            let zone;

            // Determine zone
            const shrinkFactor = game.config.shrinkingZones ? (1 - t.progress * game.config.shrinkFactor) : 1;
            const sweetMin = 50 - (2.5 * shrinkFactor);
            const sweetMax = 50 + (2.5 * shrinkFactor);
            const greenMin = 50 - (15 * shrinkFactor);
            const greenMax = 50 + (15 * shrinkFactor);

            if (pos >= sweetMin && pos <= sweetMax) {
                successChance = zoneConfig.sweetSpotChance;
                zone = 'sweet';
            } else if (pos >= greenMin && pos <= greenMax) {
                successChance = zoneConfig.greenChance;
                zone = 'green';
            } else if (pos >= 20 && pos <= 80) {
                successChance = zoneConfig.yellowChance;
                zone = 'yellow';
            } else {
                successChance = zoneConfig.redChance;
                zone = 'red';
            }

            // Precision card - only sweet spot counts
            if (t.challengeCard === 'precision' && zone !== 'sweet') {
                successChance = 0;
            }

            const success = Math.random() < successChance;

            // Hide meter
            const meter = document.getElementById(`meter-${team}`);
            meter.style.display = 'none';
            meter.classList.remove('wobble', 'blindfold');

            const cup = document.getElementById(`cup-${team}`);
            const result = document.getElementById(`result-${team}`);

            if (success) {
                cup.className = 'cup flipped';
                result.textContent = 'LANDED!';
                result.className = 'result-flash success';

                // Confetti
                const cupArea = cup.getBoundingClientRect();
                spawnConfetti(cupArea.left + cupArea.width/2, cupArea.top, zone === 'sweet' ? 50 : 30);

                // Feedback
                if (t.attempts >= 4) {
                    showFeedback(team, 'clutch');
                } else if (zone === 'sweet') {
                    showFeedback(team, 'perfect');
                } else if (zone === 'green') {
                    showFeedback(team, 'clean');
                } else if (zone === 'yellow') {
                    showFeedback(team, 'sloppy');
                } else {
                    showFeedback(team, 'lucky');
                    if (game.mode === 'chaos') {
                        showDrinkingPrompt('luckyBastard');
                    }
                }

                t.flips++;
                t.combo++;
                if (t.combo > t.bestCombo) t.bestCombo = t.combo;

                if (game.config.timed) {
                    game.globalCombo++;
                    if (game.globalCombo > game.globalBestCombo) game.globalBestCombo = game.globalCombo;
                }

                setTimeout(() => progressPlayer(team), 1200);
            } else {
                cup.className = 'cup fallen';
                result.textContent = 'MISS!';
                result.className = 'result-flash fail';

                triggerScreenShake(false);

                if (t.combo >= 3) {
                    showDrinkingPrompt('comboBreaker');
                }

                t.combo = 0;
                if (game.config.timed) game.globalCombo = 0;

                // Feedback
                if (zone === 'green' || zone === 'sweet') {
                    showFeedback(team, 'choke');
                    if (game.mode === 'chaos') {
                        showDrinkingPrompt('chokeTax');
                    }
                } else if (t.attempts >= 3) {
                    showFeedback(team, 'pathetic');
                    triggerGlitch();
                    triggerScreenShake(true);
                    if (game.mode === 'chaos') {
                        showDrinkingPrompt('patheticTax');
                    }
                }

                const maxAttempts = t.challengeCard === 'pressure' ? 1 : game.config.maxAttempts;

                // Pressure card elimination
                if (t.challengeCard === 'pressure') {
                    setTimeout(() => {
                        result.textContent = 'MERCY!';
                        cup.className = 'cup flipped';
                        t.flips++;
                        setTimeout(() => progressPlayer(team), 800);
                    }, 800);
                    return;
                }

                // Mercy rule
                if (t.attempts >= maxAttempts) {
                    setTimeout(() => {
                        result.textContent = 'MERCY!';
                        cup.className = 'cup flipped';
                        showFeedback(team, 'pathetic');
                        triggerScreenShake(true);
                        if (game.mode === 'chaos') {
                            showDrinkingPrompt('mercyShame');
                        }
                        t.flips++;
                        setTimeout(() => progressPlayer(team), 800);
                    }, 800);
                } else {
                    // Retry
                    setTimeout(() => {
                        cup.className = 'cup on-edge';
                        result.textContent = '';
                        t.phase = 'flip';
                        t.meterPos = 50;
                        t.meterDir = Math.random() > 0.5 ? 1 : -1;

                        const meter = document.getElementById(`meter-${team}`);
                        meter.style.display = 'block';

                        if (t.challengeCard === 'blindfold') {
                            meter.classList.add('blindfold');
                        }
                        updateMeterWobble(team);

                        updateAttempts(team, `Attempt ${t.attempts + 1}/${maxAttempts}`);
                    }, 1000);
                }
            }
        }

        function progressPlayer(team) {
            const t = game.teams[team];
            const count = team === 'a' ? game.teamACount : game.teamBCount;

            t.currentFlip++;
            game.roundNumber++;

            // Chaos mode - timed, keep flipping
            if (game.config.timed) {
                document.getElementById(`flips-${team}`).textContent = `FLIPS: ${t.flips}`;
                setTimeout(() => startDrinkPhase(team), 500);
                return;
            }

            // Classic mode - check if player completed their flips
            if (t.currentFlip >= game.config.flipsPerPlayer) {
                document.getElementById(`dot-${team}-${t.progress}`).classList.remove('active');
                document.getElementById(`dot-${team}-${t.progress}`).classList.add('done');
                t.progress++;
                t.currentFlip = 0;

                if (t.progress >= count) {
                    endGame(team);
                    return;
                }

                document.getElementById(`dot-${team}-${t.progress}`).classList.add('active');
            }

            setTimeout(() => startDrinkPhase(team), 800);
        }

        function endGame(winner) {
            game.started = false;

            const winScreen = document.getElementById('win-screen');
            const winnerText = document.getElementById('winner-text');
            const loserText = document.getElementById('loser-text');

            if (game.config.timed) {
                const aFlips = game.teams.a.flips;
                const bFlips = game.teams.b.flips;

                if (aFlips > bFlips) {
                    winnerText.textContent = 'TEAM A WINS!';
                    winnerText.className = 'winner-text team-a';
                    loserText.textContent = `${aFlips} vs ${bFlips} FLIPS`;
                } else if (bFlips > aFlips) {
                    winnerText.textContent = 'TEAM B WINS!';
                    winnerText.className = 'winner-text team-b';
                    loserText.textContent = `${bFlips} vs ${aFlips} FLIPS`;
                } else {
                    winnerText.textContent = 'TIE GAME!';
                    winnerText.className = 'winner-text';
                    loserText.textContent = `BOTH GOT ${aFlips} FLIPS`;
                }

                document.getElementById('stat-flips').textContent = aFlips + bFlips;
                document.getElementById('stat-combo').textContent = game.globalBestCombo;
            } else if (winner) {
                winnerText.textContent = winner === 'a' ? 'TEAM A WINS!' : 'TEAM B WINS!';
                winnerText.className = 'winner-text team-' + winner;
                loserText.textContent = 'LOSERS DRINK!';

                document.getElementById('stat-flips').textContent = game.teams.a.flips + game.teams.b.flips;
                document.getElementById('stat-combo').textContent = Math.max(game.teams.a.bestCombo, game.teams.b.bestCombo);
            }

            document.getElementById('stat-drinks').textContent = game.totalDrinks;
            winScreen.style.display = 'flex';
        }

        function resetGame() {
            document.getElementById('win-screen').style.display = 'none';
            document.getElementById('game-screen').classList.remove('active');
            document.getElementById('landing-screen').classList.add('active');
            document.getElementById('game-header').classList.add('hidden');

            game.started = false;
        }

        // ============ MEDIAPIPE SETUP ============
        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({
            maxNumHands: 2,
            modelComplexity: 0,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        hands.onResults(onHandResults);

        async function setup() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 1280, height: 720, facingMode: 'user' }
                });
                video.srcObject = stream;
                previewVideo.srcObject = stream;
                await new Promise(r => { video.onloadedmetadata = () => { video.play(); r(); }; });
                previewVideo.play();

                const cam = new Camera(video, {
                    onFrame: async () => {
                        await hands.send({ image: video });
                    },
                    width: 1280,
                    height: 720
                });
                await cam.start();

                document.getElementById('loading').classList.add('hidden');
            } catch (e) {
                document.getElementById('loading').textContent = 'CAMERA ERROR: ' + e.message;
            }
        }

        setup();
    </script>
</body>
</html>
