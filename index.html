<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flip Cup AR - Chaos Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #1a0a2e;
            overflow: hidden;
            font-family: 'Press Start 2P', monospace;
        }

        #game-container { position: relative; width: 100vw; height: 100vh; }
        #webcam { position: absolute; opacity: 0; pointer-events: none; }

        /* Screen Shake */
        .screen-shake {
            animation: shake 0.3s ease-out;
        }
        @keyframes shake {
            0%, 100% { transform: translate(0, 0); }
            20% { transform: translate(-10px, 5px); }
            40% { transform: translate(10px, -5px); }
            60% { transform: translate(-5px, 10px); }
            80% { transform: translate(5px, -10px); }
        }
        .screen-shake-big {
            animation: shakeBig 0.5s ease-out;
        }
        @keyframes shakeBig {
            0%, 100% { transform: translate(0, 0); }
            10% { transform: translate(-15px, 10px); }
            20% { transform: translate(15px, -10px); }
            30% { transform: translate(-20px, 5px); }
            40% { transform: translate(20px, -5px); }
            50% { transform: translate(-10px, 15px); }
            60% { transform: translate(10px, -15px); }
            70% { transform: translate(-15px, 10px); }
            80% { transform: translate(15px, -10px); }
            90% { transform: translate(-5px, 5px); }
        }

        /* Glitch Effect */
        .glitch-effect {
            animation: glitch 0.4s ease-out;
        }
        @keyframes glitch {
            0% { filter: none; }
            20% { filter: hue-rotate(90deg) saturate(2); transform: translate(3px, 0); }
            40% { filter: hue-rotate(-90deg) saturate(2); transform: translate(-3px, 0); }
            60% { filter: hue-rotate(180deg) brightness(1.5); transform: translate(2px, -2px); }
            80% { filter: hue-rotate(-180deg) contrast(2); transform: translate(-2px, 2px); }
            100% { filter: none; transform: translate(0, 0); }
        }

        /* Vaporwave Background */
        .vaporwave-bg {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(180deg,
                #0f0520 0%,
                #1a0a3a 20%,
                #2d1b4e 40%,
                #ff6b9d 70%,
                #ffa07a 85%,
                #ffcc00 100%
            );
            overflow: hidden;
        }

        .grid-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50%;
            perspective: 400px;
            overflow: hidden;
        }
        .grid {
            position: absolute;
            bottom: 0;
            left: -50%;
            width: 200%;
            height: 200%;
            background-image:
                linear-gradient(to right, #ff00ff33 1px, transparent 1px),
                linear-gradient(to bottom, #ff00ff33 1px, transparent 1px);
            background-size: 60px 60px;
            transform: rotateX(60deg);
            animation: gridMove 2s linear infinite;
        }
        @keyframes gridMove {
            0% { transform: rotateX(60deg) translateY(0); }
            100% { transform: rotateX(60deg) translateY(60px); }
        }

        .sun {
            position: absolute;
            bottom: 25%;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 300px;
            background: linear-gradient(180deg, #ffcc00 0%, #ff6b6b 50%, #ff00ff 100%);
            border-radius: 50%;
            box-shadow: 0 0 100px #ff6b6b, 0 0 200px #ff00ff55;
        }
        .sun-lines {
            position: absolute;
            bottom: 25%;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 150px;
            overflow: hidden;
        }
        .sun-line {
            position: absolute;
            left: 0;
            width: 100%;
            height: 8px;
            background: #1a0a2e;
        }

        .neon-sign {
            position: absolute;
            font-size: 14px;
            text-shadow:
                0 0 5px currentColor,
                0 0 10px currentColor,
                0 0 20px currentColor,
                0 0 40px currentColor;
            animation: flicker 3s infinite;
        }
        @keyframes flicker {
            0%, 95%, 100% { opacity: 1; }
            96%, 98% { opacity: 0.8; }
            97% { opacity: 0.4; }
        }
        .neon-left { top: 80px; left: 30px; color: #00ffff; }
        .neon-right { top: 80px; right: 30px; color: #ff00ff; }

        /* Confetti */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 500;
            overflow: hidden;
        }
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            opacity: 0;
        }
        .confetti.active {
            animation: confettiFall 1.5s ease-out forwards;
        }
        @keyframes confettiFall {
            0% { opacity: 1; transform: translateY(0) rotate(0deg); }
            100% { opacity: 0; transform: translateY(400px) rotate(720deg); }
        }

        /* Drinking Prompt Overlay */
        #drinking-prompt {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 42px;
            color: #ffcc00;
            text-shadow:
                0 0 20px #ffcc00,
                0 0 40px #ff6600,
                4px 4px 0 #000;
            z-index: 600;
            opacity: 0;
            pointer-events: none;
            text-align: center;
            white-space: nowrap;
        }
        #drinking-prompt.show {
            animation: drinkPromptPop 2.5s ease-out forwards;
        }
        @keyframes drinkPromptPop {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.3); }
            15% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            25% { transform: translate(-50%, -50%) scale(1); }
            75% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -60%) scale(0.8); }
        }

        /* Challenge Card */
        #challenge-card {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1a0a3a, #2d1b4e);
            border: 4px solid #ff00ff;
            padding: 30px 50px;
            z-index: 550;
            opacity: 0;
            pointer-events: none;
            text-align: center;
            box-shadow: 0 0 50px #ff00ff88;
        }
        #challenge-card.show {
            animation: cardReveal 2s ease-out forwards;
        }
        @keyframes cardReveal {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0) rotateY(180deg); }
            30% { opacity: 1; transform: translate(-50%, -50%) scale(1.1) rotateY(0deg); }
            40% { transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
        #challenge-card .card-title {
            font-size: 14px;
            color: #888;
            margin-bottom: 15px;
        }
        #challenge-card .card-name {
            font-size: 28px;
            color: #00ffff;
            text-shadow: 0 0 20px #00ffff;
            margin-bottom: 10px;
        }
        #challenge-card .card-desc {
            font-size: 12px;
            color: #ff6b9d;
        }

        /* Callout Buttons */
        #callout-ui {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            z-index: 400;
        }
        .callout-title {
            font-size: 18px;
            color: #fff;
            text-shadow: 0 0 10px #00ffff;
            margin-bottom: 10px;
        }
        .callout-buttons {
            display: flex;
            gap: 15px;
        }
        .callout-btn {
            padding: 15px 25px;
            font-family: 'Press Start 2P', monospace;
            font-size: 14px;
            border: 3px solid;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(0,0,0,0.8);
        }
        .callout-btn:hover {
            transform: scale(1.1);
        }
        .callout-btn.perfect {
            color: #00ff00;
            border-color: #00ff00;
            box-shadow: 0 0 20px #00ff0055;
        }
        .callout-btn.perfect:hover { box-shadow: 0 0 30px #00ff00aa; }
        .callout-btn.clean {
            color: #00ffaa;
            border-color: #00ffaa;
            box-shadow: 0 0 20px #00ffaa55;
        }
        .callout-btn.clean:hover { box-shadow: 0 0 30px #00ffffaa; }
        .callout-btn.safe {
            color: #888;
            border-color: #888;
        }
        .callout-btn.safe:hover { box-shadow: 0 0 20px #88888855; }

        .callout-indicator {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            padding: 5px 15px;
            border-radius: 5px;
            display: none;
        }
        .callout-indicator.perfect {
            background: #00ff00;
            color: #000;
        }
        .callout-indicator.clean {
            background: #00ffaa;
            color: #000;
        }

        /* Webcam preview */
        #webcam-area {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
        }
        #webcam-preview {
            width: 360px;
            height: 270px;
            border: 4px solid #00ffff;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 0 20px #00ffff55, 0 0 40px #ff00ff33;
        }
        #webcam-preview video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        .hand-indicator {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 3px solid #fff;
            pointer-events: none;
            display: none;
            transform: translate(-50%, -50%);
        }
        #hand-left { background: rgba(255, 107, 157, 0.8); box-shadow: 0 0 15px #ff6b9d; }
        #hand-right { background: rgba(0, 255, 255, 0.8); box-shadow: 0 0 15px #00ffff; }

        .gesture-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #fff;
            white-space: nowrap;
            background: rgba(0,0,0,0.8);
            padding: 2px 8px;
            border-radius: 10px;
            text-shadow: 0 0 5px #00ffff;
        }

        /* Setup Screen */
        #setup-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 200;
        }
        .title {
            font-size: 64px;
            color: #00ffff;
            margin-bottom: 5px;
            text-shadow:
                4px 4px 0 #ff00ff,
                0 0 20px #00ffff,
                0 0 40px #00ffff;
            letter-spacing: 8px;
        }
        .subtitle {
            font-size: 18px;
            color: #ff6b9d;
            margin-bottom: 30px;
            text-shadow: 0 0 10px #ff6b9d;
            letter-spacing: 4px;
        }

        .instructions {
            background: rgba(0,0,0,0.85);
            border: 2px solid #ff00ff;
            padding: 20px 40px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 0 20px #ff00ff55;
        }
        .instructions p {
            color: #fff;
            font-size: 12px;
            margin: 10px 0;
            line-height: 1.8;
        }
        .instructions .highlight { color: #00ffff; }

        /* Mode Selection */
        .mode-select {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .mode-btn {
            padding: 18px 20px;
            background: rgba(0,0,0,0.8);
            border: 3px solid #444;
            color: #888;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 140px;
            text-align: center;
        }
        .mode-btn:hover, .mode-btn.selected {
            border-color: #00ffff;
            color: #00ffff;
            box-shadow: 0 0 20px #00ffff55;
        }
        .mode-btn.chaos-btn {
            border-color: #ff00ff;
            background: linear-gradient(135deg, rgba(255,0,255,0.2), rgba(0,255,255,0.2));
            animation: chaosPulse 2s infinite;
        }
        .mode-btn.chaos-btn:hover, .mode-btn.chaos-btn.selected {
            border-color: #ff00ff;
            color: #ff00ff;
            box-shadow: 0 0 30px #ff00ff88;
        }
        @keyframes chaosPulse {
            0%, 100% { box-shadow: 0 0 10px #ff00ff55; }
            50% { box-shadow: 0 0 25px #ff00ff88, 0 0 40px #00ffff44; }
        }
        .mode-btn .mode-name {
            font-size: 12px;
            margin-bottom: 8px;
        }
        .mode-btn .mode-desc {
            font-size: 7px;
            color: #ff6b9d;
            line-height: 1.6;
        }

        .team-setup { display: flex; gap: 50px; margin-bottom: 25px; }
        .team-box {
            text-align: center;
            background: rgba(0,0,0,0.8);
            padding: 20px 35px;
            border: 2px solid #333;
        }
        .team-box.team-a { border-color: #ff6b9d; box-shadow: 0 0 15px #ff6b9d33; }
        .team-box.team-b { border-color: #00ffff; box-shadow: 0 0 15px #00ffff33; }
        .team-label { font-size: 18px; color: #fff; margin-bottom: 12px; }
        .team-a .team-label { color: #ff6b9d; text-shadow: 0 0 10px #ff6b9d; }
        .team-b .team-label { color: #00ffff; text-shadow: 0 0 10px #00ffff; }

        .player-count { display: flex; align-items: center; gap: 12px; }
        .player-count button {
            width: 35px; height: 35px; font-size: 18px; border: none;
            background: #333; color: #fff; cursor: pointer;
            font-family: 'Press Start 2P', monospace;
        }
        .player-count button:hover { background: #555; }
        .player-count .count { font-size: 32px; color: #fff; width: 45px; text-align: center; }

        #start-btn {
            padding: 18px 50px; font-size: 18px;
            background: linear-gradient(180deg, #ff00ff, #ff6b9d);
            color: #fff; border: none; cursor: pointer;
            text-shadow: 2px 2px 0 #000;
            box-shadow: 0 0 30px #ff00ff55;
            transition: all 0.2s;
            font-family: 'Press Start 2P', monospace;
        }
        #start-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 50px #ff00ff88;
        }

        /* Game Screen */
        #game-screen {
            display: none;
            width: 100%;
            height: 100%;
        }

        .split-screen { display: flex; width: 100%; height: calc(100% - 310px); }
        .team-side {
            flex: 1; display: flex; flex-direction: column; align-items: center;
            padding: 15px; position: relative;
        }
        .team-side.team-a { border-right: 3px solid #ff00ff55; }

        .team-header {
            font-size: 24px; font-weight: bold; margin-bottom: 8px;
        }
        .team-a .team-header { color: #ff6b9d; text-shadow: 0 0 20px #ff6b9d; }
        .team-b .team-header { color: #00ffff; text-shadow: 0 0 20px #00ffff; }

        .player-indicators { display: flex; gap: 10px; margin-bottom: 12px; }
        .player-dot {
            width: 28px; height: 28px; border-radius: 50%; background: #333;
            border: 3px solid #666; transition: all 0.3s;
        }
        .player-dot.done { background: #00ff00; border-color: #00ff00; box-shadow: 0 0 15px #00ff00; }
        .player-dot.active {
            background: #ffcc00;
            border-color: #ffcc00;
            animation: pulse 0.8s infinite;
            box-shadow: 0 0 20px #ffcc00;
        }
        .player-dot.eliminated { background: #ff0000; border-color: #ff0000; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }

        .game-area {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: flex-start;
            width: 100%; padding-top: 5px;
        }

        .status-message {
            font-size: 28px; font-weight: bold; color: #fff; text-align: center;
            text-shadow: 0 0 20px currentColor; margin-bottom: 10px;
            min-height: 45px;
        }
        .status-message.drink { color: #ffcc00; }
        .status-message.ready { color: #00ffff; }

        .player-state {
            font-size: 11px;
            color: #fff;
            background: rgba(0,0,0,0.6);
            padding: 5px 12px;
            margin-bottom: 8px;
        }
        .player-state.raised { background: #00aa00; box-shadow: 0 0 10px #00ff00; }

        /* Challenge indicator */
        .challenge-indicator {
            font-size: 10px;
            color: #ff00ff;
            background: rgba(0,0,0,0.8);
            padding: 4px 12px;
            margin-bottom: 8px;
            border: 1px solid #ff00ff;
            text-shadow: 0 0 5px #ff00ff;
        }

        /* Shot Meter */
        .meter-container {
            width: 90%; max-width: 300px; height: 32px; background: #111;
            position: relative; overflow: hidden;
            border: 3px solid #00ffff;
            margin-bottom: 15px;
            display: none;
            box-shadow: 0 0 15px #00ffff55;
        }
        .meter-container.wobble {
            animation: meterWobble var(--wobble-speed, 0.5s) ease-in-out infinite;
        }
        @keyframes meterWobble {
            0%, 100% { transform: translateX(var(--wobble-amount, 0px)) rotate(var(--wobble-rotate, 0deg)); }
            50% { transform: translateX(calc(var(--wobble-amount, 0px) * -1)) rotate(calc(var(--wobble-rotate, 0deg) * -1)); }
        }
        .meter-container.blindfold .meter-zones,
        .meter-container.blindfold .meter-needle {
            opacity: 0;
        }
        .meter-container.blindfold::after {
            content: '???';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            color: #ff00ff;
        }

        .meter-zones {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            transition: all 0.3s;
        }
        .meter-zone { height: 100%; transition: flex 0.3s; }
        .meter-zone.red-left { background: #aa0000; }
        .meter-zone.yellow-left { background: #aa8800; }
        .meter-zone.green { background: #00aa00; }
        .meter-zone.sweet-spot { background: #00ff00; box-shadow: inset 0 0 10px #fff; }
        .meter-zone.green-right { background: #00aa00; }
        .meter-zone.yellow-right { background: #aa8800; }
        .meter-zone.red-right { background: #aa0000; }

        .meter-needle {
            position: absolute; top: -5px; bottom: -5px; width: 6px;
            background: #fff; border: 2px solid #000;
            transform: translateX(-50%);
            box-shadow: 0 0 10px #fff;
        }

        /* Cup Area */
        .cup-area {
            width: 100%;
            max-width: 260px;
            height: 140px;
            position: relative;
        }

        .bar-surface {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 32px;
            background: linear-gradient(180deg, #4a3728 0%, #2a1a10 100%);
            border: 3px solid #1a0a05;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .cup {
            position: absolute;
            bottom: 28px;
            left: 50%;
            width: 45px;
            height: 65px;
            transform: translateX(-50%);
            transition: transform 0.3s ease;
        }

        .cup-body { fill: #ff0044; stroke: #aa0033; stroke-width: 2; }
        .cup-rim { fill: #ff3366; }
        .cup-shine { fill: rgba(255,255,255,0.3); }
        .cup-beer { fill: #ffaa00; }

        .cup.on-edge { transform: translateX(-50%) translateX(30px); }
        .cup.flipped { transform: translateX(-50%) rotate(180deg); bottom: 30px; }
        .cup.fallen { transform: translateX(-50%) rotate(90deg) translateY(12px); bottom: 40px; }

        /* Feedback Flash */
        .feedback-flash {
            position: absolute;
            top: 45%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 42px;
            font-weight: bold;
            pointer-events: none;
            opacity: 0;
            z-index: 50;
        }
        .feedback-flash.show {
            animation: feedbackPop 1.2s ease-out forwards;
        }
        @keyframes feedbackPop {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.3); }
            40% { transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -60%) scale(1); }
        }
        .feedback-flash.perfect { color: #00ff00; text-shadow: 0 0 30px #00ff00, 0 0 60px #00ff00; }
        .feedback-flash.clean { color: #00ffaa; text-shadow: 0 0 30px #00ffaa; }
        .feedback-flash.sloppy { color: #ffaa00; text-shadow: 0 0 30px #ffaa00; }
        .feedback-flash.lucky { color: #ff00ff; text-shadow: 0 0 30px #ff00ff; }
        .feedback-flash.choke { color: #ff0000; text-shadow: 0 0 30px #ff0000; }
        .feedback-flash.pathetic { color: #ff0044; text-shadow: 0 0 30px #ff0044; animation: feedbackShake 1.2s ease-out forwards; }
        .feedback-flash.clutch { color: #ffcc00; text-shadow: 0 0 40px #ffcc00, 0 0 80px #ff6600; }

        @keyframes feedbackShake {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.3) rotate(-5deg); }
            30% { transform: translate(-50%, -50%) scale(1) rotate(5deg); }
            40% { transform: translate(-50%, -50%) scale(1) rotate(-3deg); }
            50% { transform: translate(-50%, -50%) scale(1) rotate(0deg); }
            100% { opacity: 0; transform: translate(-50%, -60%) scale(1); }
        }

        .result-flash {
            font-size: 24px; font-weight: bold;
            text-shadow: 0 0 15px currentColor;
            min-height: 35px;
            margin-top: 3px;
        }
        .result-flash.success { color: #00ff00; }
        .result-flash.fail { color: #ff0000; }

        .attempt-counter {
            font-size: 9px;
            color: #aaa;
            margin-top: 3px;
        }

        .flip-count {
            font-size: 12px;
            color: #ffcc00;
            text-shadow: 0 0 10px #ffcc00;
            margin-top: 8px;
        }

        /* Mode-specific UI */
        .mode-timer {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 32px;
            color: #00ffff;
            text-shadow: 0 0 20px #00ffff;
        }
        .mode-timer.warning { color: #ff6600; text-shadow: 0 0 20px #ff6600; animation: timerPulse 0.5s infinite; }
        @keyframes timerPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        .combo-display {
            position: absolute;
            top: 55px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 20px;
            color: #ff00ff;
            text-shadow: 0 0 15px #ff00ff;
        }

        /* Win Screen */
        #win-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); display: none; flex-direction: column;
            justify-content: center; align-items: center; z-index: 300;
        }
        .winner-text {
            font-size: 48px; font-weight: bold; margin-bottom: 15px;
        }
        .winner-text.team-a { color: #ff6b9d; text-shadow: 0 0 40px #ff6b9d; }
        .winner-text.team-b { color: #00ffff; text-shadow: 0 0 40px #00ffff; }
        .loser-text { font-size: 20px; color: #ffcc00; margin-bottom: 30px; text-shadow: 0 0 15px #ffcc00; }

        .final-stats {
            background: rgba(0,0,0,0.8);
            border: 3px solid #ff00ff;
            padding: 25px 40px;
            margin-bottom: 25px;
            text-align: center;
        }
        .stat-line { font-size: 12px; color: #fff; margin: 10px 0; }
        .stat-value { color: #00ffff; }

        #play-again-btn {
            padding: 18px 45px; font-size: 16px;
            background: linear-gradient(180deg, #00ffff, #0088aa);
            color: #000; border: none; cursor: pointer;
            font-family: 'Press Start 2P', monospace;
            box-shadow: 0 0 30px #00ffff55;
        }

        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 14px; color: #00ffff; z-index: 400; background: #0a0015;
            padding: 25px 40px; border: 3px solid #ff00ff;
            text-shadow: 0 0 10px #00ffff;
            box-shadow: 0 0 30px #ff00ff55;
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="game-container">
        <video id="webcam" autoplay playsinline></video>

        <!-- Vaporwave Background -->
        <div class="vaporwave-bg">
            <div class="sun"></div>
            <div class="sun-lines">
                <div class="sun-line" style="top: 20%"></div>
                <div class="sun-line" style="top: 35%"></div>
                <div class="sun-line" style="top: 48%"></div>
                <div class="sun-line" style="top: 60%"></div>
                <div class="sun-line" style="top: 72%"></div>
                <div class="sun-line" style="top: 82%"></div>
                <div class="sun-line" style="top: 90%"></div>
            </div>
            <div class="grid-container">
                <div class="grid"></div>
            </div>
        </div>

        <div class="neon-sign neon-left">TEAM A</div>
        <div class="neon-sign neon-right">TEAM B</div>

        <!-- Confetti Container -->
        <div class="confetti-container" id="confetti-container"></div>

        <!-- Drinking Prompt -->
        <div id="drinking-prompt"></div>

        <!-- Challenge Card -->
        <div id="challenge-card">
            <div class="card-title">CHALLENGE CARD</div>
            <div class="card-name" id="card-name">BLINDFOLD</div>
            <div class="card-desc" id="card-desc">Meter is hidden!</div>
        </div>

        <!-- Setup Screen -->
        <div id="setup-screen">
            <div class="title">FLIP CUP</div>
            <div class="subtitle">CHAOS EDITION</div>

            <div class="instructions">
                <p><span class="highlight">1.</span> DRINK YOUR CUP IRL</p>
                <p><span class="highlight">2.</span> RAISE HAND WHEN READY</p>
                <p><span class="highlight">3.</span> FLICK UP ON THE BEAT</p>
            </div>

            <div class="mode-select">
                <button class="mode-btn selected" data-mode="classic">
                    <div class="mode-name">CLASSIC</div>
                    <div class="mode-desc">RELAY RACE<br>5 FLIPS EACH</div>
                </button>
                <button class="mode-btn" data-mode="sudden">
                    <div class="mode-name">SUDDEN DEATH</div>
                    <div class="mode-desc">MISS = OUT<br>LAST STANDING</div>
                </button>
                <button class="mode-btn" data-mode="speed">
                    <div class="mode-name">SPEED DEMON</div>
                    <div class="mode-desc">60 SECONDS<br>MOST FLIPS</div>
                </button>
                <button class="mode-btn chaos-btn" data-mode="chaos">
                    <div class="mode-name">CHAOS</div>
                    <div class="mode-desc">FULL SEND<br>ALL MODIFIERS</div>
                </button>
            </div>

            <div class="team-setup">
                <div class="team-box team-a">
                    <div class="team-label">TEAM A</div>
                    <div class="player-count">
                        <button onclick="adjustTeam('a', -1)">-</button>
                        <span class="count" id="team-a-count">2</span>
                        <button onclick="adjustTeam('a', 1)">+</button>
                    </div>
                </div>
                <div class="team-box team-b">
                    <div class="team-label">TEAM B</div>
                    <div class="player-count">
                        <button onclick="adjustTeam('b', -1)">-</button>
                        <span class="count" id="team-b-count">2</span>
                        <button onclick="adjustTeam('b', 1)">+</button>
                    </div>
                </div>
            </div>

            <button id="start-btn" onclick="startGame()">START</button>
        </div>

        <!-- Game Screen -->
        <div id="game-screen">
            <div class="mode-timer hidden" id="mode-timer">60</div>
            <div class="combo-display hidden" id="combo-display">0x COMBO</div>

            <!-- Callout UI (for CHAOS mode) -->
            <div id="callout-ui">
                <div class="callout-title">CALL YOUR SHOT!</div>
                <div class="callout-buttons">
                    <button class="callout-btn perfect" onclick="makeCallout('a', 'perfect')">PERFECT</button>
                    <button class="callout-btn clean" onclick="makeCallout('a', 'clean')">CLEAN</button>
                    <button class="callout-btn safe" onclick="makeCallout('a', 'safe')">SAFE</button>
                </div>
            </div>

            <div class="split-screen">
                <!-- Team A Side -->
                <div class="team-side team-a">
                    <div class="team-header">TEAM A</div>
                    <div class="player-indicators" id="team-a-indicators"></div>
                    <div class="game-area">
                        <div class="status-message" id="status-a"></div>
                        <div class="challenge-indicator hidden" id="challenge-a"></div>
                        <div class="player-state" id="state-a">Waiting...</div>
                        <div class="callout-indicator" id="callout-a"></div>
                        <div class="meter-container" id="meter-a">
                            <div class="meter-zones" id="zones-a">
                                <div class="meter-zone red-left" style="flex: 2"></div>
                                <div class="meter-zone yellow-left" style="flex: 1.5"></div>
                                <div class="meter-zone green" style="flex: 1.25"></div>
                                <div class="meter-zone sweet-spot" style="flex: 0.5"></div>
                                <div class="meter-zone green-right" style="flex: 1.25"></div>
                                <div class="meter-zone yellow-right" style="flex: 1.5"></div>
                                <div class="meter-zone red-right" style="flex: 2"></div>
                            </div>
                            <div class="meter-needle" id="needle-a" style="left: 50%"></div>
                        </div>
                        <div class="cup-area">
                            <div class="cup" id="cup-a">
                                <svg viewBox="0 0 45 65" width="45" height="65">
                                    <path class="cup-body" d="M5,5 L40,5 L36,58 Q36,63 22.5,63 Q9,63 9,58 Z"/>
                                    <rect class="cup-rim" x="3" y="0" width="39" height="7" rx="2"/>
                                    <ellipse class="cup-beer" cx="22.5" cy="18" rx="13" ry="7"/>
                                    <ellipse class="cup-shine" cx="14" cy="14" rx="5" ry="3"/>
                                </svg>
                            </div>
                            <div class="bar-surface"></div>
                        </div>
                        <div class="result-flash" id="result-a"></div>
                        <div class="attempt-counter" id="attempts-a"></div>
                        <div class="flip-count" id="flips-a"></div>
                    </div>
                    <div class="feedback-flash" id="feedback-a"></div>
                </div>

                <!-- Team B Side -->
                <div class="team-side team-b">
                    <div class="team-header">TEAM B</div>
                    <div class="player-indicators" id="team-b-indicators"></div>
                    <div class="game-area">
                        <div class="status-message" id="status-b"></div>
                        <div class="challenge-indicator hidden" id="challenge-b"></div>
                        <div class="player-state" id="state-b">Waiting...</div>
                        <div class="callout-indicator" id="callout-b"></div>
                        <div class="meter-container" id="meter-b">
                            <div class="meter-zones" id="zones-b">
                                <div class="meter-zone red-left" style="flex: 2"></div>
                                <div class="meter-zone yellow-left" style="flex: 1.5"></div>
                                <div class="meter-zone green" style="flex: 1.25"></div>
                                <div class="meter-zone sweet-spot" style="flex: 0.5"></div>
                                <div class="meter-zone green-right" style="flex: 1.25"></div>
                                <div class="meter-zone yellow-right" style="flex: 1.5"></div>
                                <div class="meter-zone red-right" style="flex: 2"></div>
                            </div>
                            <div class="meter-needle" id="needle-b" style="left: 50%"></div>
                        </div>
                        <div class="cup-area">
                            <div class="cup" id="cup-b">
                                <svg viewBox="0 0 45 65" width="45" height="65">
                                    <path class="cup-body" d="M5,5 L40,5 L36,58 Q36,63 22.5,63 Q9,63 9,58 Z"/>
                                    <rect class="cup-rim" x="3" y="0" width="39" height="7" rx="2"/>
                                    <ellipse class="cup-beer" cx="22.5" cy="18" rx="13" ry="7"/>
                                    <ellipse class="cup-shine" cx="14" cy="14" rx="5" ry="3"/>
                                </svg>
                            </div>
                            <div class="bar-surface"></div>
                        </div>
                        <div class="result-flash" id="result-b"></div>
                        <div class="attempt-counter" id="attempts-b"></div>
                        <div class="flip-count" id="flips-b"></div>
                    </div>
                    <div class="feedback-flash" id="feedback-b"></div>
                </div>
            </div>

            <!-- Webcam Area -->
            <div id="webcam-area">
                <div id="webcam-preview">
                    <video id="preview-video" autoplay playsinline muted></video>
                    <div class="hand-indicator" id="hand-left">
                        <span class="gesture-label" id="gesture-left"></span>
                    </div>
                    <div class="hand-indicator" id="hand-right">
                        <span class="gesture-label" id="gesture-right"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Win Screen -->
        <div id="win-screen">
            <div class="winner-text" id="winner-text">TEAM A WINS!</div>
            <div class="loser-text" id="loser-text">LOSERS DRINK UP!</div>
            <div class="final-stats" id="final-stats">
                <p class="stat-line">TOTAL FLIPS: <span class="stat-value" id="stat-flips">0</span></p>
                <p class="stat-line">BEST COMBO: <span class="stat-value" id="stat-combo">0</span></p>
                <p class="stat-line">DRINKS OWED: <span class="stat-value" id="stat-drinks">0</span></p>
            </div>
            <button id="play-again-btn" onclick="resetGame()">PLAY AGAIN</button>
        </div>

        <div id="loading">LOADING CAMERA...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>

    <script>
        const video = document.getElementById('webcam');
        const previewVideo = document.getElementById('preview-video');

        // ============ CHALLENGE CARDS ============
        const challengeCards = {
            blindfold: { name: 'BLINDFOLD', desc: 'Meter is hidden!', effect: 'blindfold' },
            pressure: { name: 'PRESSURE', desc: 'Only 1 attempt!', effect: 'pressure' },
            speed: { name: 'SPEED', desc: '2x meter speed!', effect: 'speed' },
            reverse: { name: 'REVERSE', desc: 'Random direction changes!', effect: 'reverse' },
            drunk: { name: 'EXTRA DRUNK', desc: 'Maximum wobble!', effect: 'drunk' },
            precision: { name: 'PRECISION', desc: 'Only sweet spot counts!', effect: 'precision' }
        };
        const cardKeys = Object.keys(challengeCards);

        // ============ DRINKING RULES ============
        const drinkingPrompts = {
            chokeTax: "CHOKE TAX! ðŸº",
            mercyShame: "MERCY SHAME! ðŸºðŸº",
            comboBreaker: "COMBO BREAKER! ðŸº",
            luckyBastard: "LUCKY! THEY DRINK! ðŸº",
            patheticTax: "PATHETIC TAX! ðŸºðŸº",
            wrongCallout: "WRONG CALL! ðŸº",
            perfectBonus: "CALLED IT! +500"
        };

        // ============ GAME CONFIG ============
        const configs = {
            classic: {
                flipsPerPlayer: 5,
                baseMeterSpeed: 1.2,
                meterSpeedIncrease: 0.15,
                wobbleEnabled: false,
                shrinkingZones: false,
                challengeCards: false,
                calloutSystem: false,
                maxAttempts: 5
            },
            sudden: {
                flipsPerPlayer: 1,
                baseMeterSpeed: 1.3,
                meterSpeedIncrease: 0.1,
                wobbleEnabled: false,
                shrinkingZones: false,
                challengeCards: false,
                calloutSystem: false,
                maxAttempts: 1
            },
            speed: {
                flipsPerPlayer: 999,
                baseMeterSpeed: 1.4,
                meterSpeedIncrease: 0,
                wobbleEnabled: false,
                shrinkingZones: false,
                challengeCards: false,
                calloutSystem: false,
                maxAttempts: 3
            },
            chaos: {
                flipsPerPlayer: 3,
                baseMeterSpeed: 1.5,
                meterSpeedIncrease: 0.2,
                wobbleEnabled: true,
                wobbleBase: 5,
                wobbleIncrease: 5,
                shrinkingZones: true,
                shrinkFactor: 0.12,
                challengeCards: true,
                calloutSystem: true,
                maxAttempts: 3
            }
        };

        // Zone config
        const zoneConfig = {
            sweetSpotMin: 47.5,
            sweetSpotMax: 52.5,
            greenMin: 35,
            greenMax: 65,
            yellowMin: 20,
            yellowMax: 80,
            sweetSpotChance: 0.95,
            greenChance: 0.70,
            yellowChance: 0.35,
            redChance: 0.10
        };

        // ============ GAME STATE ============
        const game = {
            mode: 'classic',
            config: configs.classic,
            teamACount: 2,
            teamBCount: 2,
            teams: {
                a: createTeamState(),
                b: createTeamState()
            },
            started: false,
            timeLeft: 60,
            startTime: 0,
            globalCombo: 0,
            globalBestCombo: 0,
            totalDrinks: 0,
            roundNumber: 0,
            hands: {
                left: { x: 0, y: 0, visible: false, gesture: '', lastY: 0 },
                right: { x: 0, y: 0, visible: false, gesture: '', lastY: 0 }
            }
        };

        function createTeamState() {
            return {
                progress: 0,
                phase: 'waiting',
                meterPos: 50,
                meterDir: 1,
                attempts: 0,
                handRaised: false,
                flips: 0,
                combo: 0,
                bestCombo: 0,
                eliminated: false,
                currentFlip: 0,
                challengeCard: null,
                callout: null,
                reverseTimer: 0
            };
        }

        // ============ FEEDBACK MESSAGES ============
        const feedback = {
            perfect: 'PERFECT!',
            clean: 'CLEAN!',
            sloppy: 'SLOPPY!',
            lucky: 'LUCKY!',
            choke: 'CHOKE!',
            pathetic: 'PATHETIC!',
            clutch: 'CLUTCH!'
        };

        // ============ MODE SELECTION ============
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                game.mode = btn.dataset.mode;
                game.config = configs[game.mode];
            });
        });

        // ============ TEAM SETUP ============
        function adjustTeam(team, delta) {
            if (team === 'a') {
                game.teamACount = Math.max(1, Math.min(4, game.teamACount + delta));
                document.getElementById('team-a-count').textContent = game.teamACount;
            } else {
                game.teamBCount = Math.max(1, Math.min(4, game.teamBCount + delta));
                document.getElementById('team-b-count').textContent = game.teamBCount;
            }
        }

        function createPlayerIndicators() {
            ['a', 'b'].forEach(team => {
                const container = document.getElementById(`team-${team}-indicators`);
                const count = team === 'a' ? game.teamACount : game.teamBCount;
                container.innerHTML = '';
                for (let i = 0; i < count; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'player-dot' + (i === 0 ? ' active' : '');
                    dot.id = `dot-${team}-${i}`;
                    container.appendChild(dot);
                }
            });
        }

        // ============ VISUAL EFFECTS ============
        function triggerScreenShake(big = false) {
            const container = document.getElementById('game-container');
            container.classList.remove('screen-shake', 'screen-shake-big');
            void container.offsetWidth; // Force reflow
            container.classList.add(big ? 'screen-shake-big' : 'screen-shake');
            setTimeout(() => container.classList.remove('screen-shake', 'screen-shake-big'), big ? 500 : 300);
        }

        function triggerGlitch() {
            const container = document.getElementById('game-container');
            container.classList.remove('glitch-effect');
            void container.offsetWidth;
            container.classList.add('glitch-effect');
            setTimeout(() => container.classList.remove('glitch-effect'), 400);
        }

        function spawnConfetti(x, y, count = 30) {
            const container = document.getElementById('confetti-container');
            const colors = ['#ff00ff', '#00ffff', '#ffcc00', '#00ff00', '#ff6b9d', '#fff'];

            for (let i = 0; i < count; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = (x + (Math.random() - 0.5) * 100) + 'px';
                confetti.style.top = y + 'px';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                confetti.style.animationDelay = (Math.random() * 0.3) + 's';
                confetti.style.animationDuration = (1 + Math.random() * 0.5) + 's';
                container.appendChild(confetti);

                setTimeout(() => confetti.classList.add('active'), 10);
                setTimeout(() => confetti.remove(), 2000);
            }
        }

        function showDrinkingPrompt(promptKey) {
            const el = document.getElementById('drinking-prompt');
            el.textContent = drinkingPrompts[promptKey];
            el.classList.remove('show');
            void el.offsetWidth;
            el.classList.add('show');

            if (promptKey !== 'perfectBonus') {
                game.totalDrinks++;
            }

            setTimeout(() => el.classList.remove('show'), 2500);
        }

        function showChallengeCard(team, cardKey) {
            const card = challengeCards[cardKey];
            document.getElementById('card-name').textContent = card.name;
            document.getElementById('card-desc').textContent = card.desc;

            const cardEl = document.getElementById('challenge-card');
            cardEl.classList.remove('show');
            void cardEl.offsetWidth;
            cardEl.classList.add('show');

            // Show indicator on team side
            const indicator = document.getElementById(`challenge-${team}`);
            indicator.textContent = card.name;
            indicator.classList.remove('hidden');
        }

        function showFeedback(team, type) {
            const el = document.getElementById(`feedback-${team}`);
            el.textContent = feedback[type];
            el.className = `feedback-flash ${type} show`;
            setTimeout(() => el.classList.remove('show'), 1200);
        }

        // ============ CALLOUT SYSTEM ============
        function makeCallout(team, callType) {
            game.teams[team].callout = callType;

            const indicator = document.getElementById(`callout-${team}`);
            if (callType !== 'safe') {
                indicator.textContent = callType.toUpperCase() + '!';
                indicator.className = `callout-indicator ${callType}`;
                indicator.style.display = 'block';
            } else {
                indicator.style.display = 'none';
            }

            document.getElementById('callout-ui').style.display = 'none';

            // Start the flip phase
            startFlipPhase(team);
        }

        // ============ METER WOBBLE ============
        function updateMeterWobble(team) {
            if (!game.config.wobbleEnabled) return;

            const meter = document.getElementById(`meter-${team}`);
            const t = game.teams[team];

            let wobbleAmount = game.config.wobbleBase + (game.roundNumber * game.config.wobbleIncrease);
            let wobbleSpeed = 0.4 - (game.roundNumber * 0.05);
            wobbleSpeed = Math.max(0.2, wobbleSpeed);

            // Extra drunk card
            if (t.challengeCard === 'drunk') {
                wobbleAmount *= 2;
                wobbleSpeed *= 0.7;
            }

            meter.style.setProperty('--wobble-amount', wobbleAmount + 'px');
            meter.style.setProperty('--wobble-rotate', (wobbleAmount / 3) + 'deg');
            meter.style.setProperty('--wobble-speed', wobbleSpeed + 's');
            meter.classList.add('wobble');
        }

        // ============ SHRINKING ZONES ============
        function updateZoneSizes(team) {
            if (!game.config.shrinkingZones) return;

            const t = game.teams[team];
            const shrink = 1 - (t.progress * game.config.shrinkFactor);

            const zones = document.getElementById(`zones-${team}`);
            const greenZones = zones.querySelectorAll('.green, .green-right');
            const sweetSpot = zones.querySelector('.sweet-spot');

            greenZones.forEach(z => z.style.flex = (1.25 * shrink));
            sweetSpot.style.flex = (0.5 * shrink);
        }

        // ============ GAME FLOW ============
        function startGame() {
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';

            game.config = configs[game.mode];
            game.teams.a = createTeamState();
            game.teams.b = createTeamState();
            game.started = true;
            game.timeLeft = 60;
            game.startTime = Date.now();
            game.globalCombo = 0;
            game.globalBestCombo = 0;
            game.totalDrinks = 0;
            game.roundNumber = 0;

            createPlayerIndicators();

            // Mode-specific setup
            if (game.mode === 'speed' || game.mode === 'chaos') {
                document.getElementById('mode-timer').classList.remove('hidden');
                document.getElementById('combo-display').classList.remove('hidden');
            } else {
                document.getElementById('mode-timer').classList.add('hidden');
                document.getElementById('combo-display').classList.add('hidden');
            }

            startDrinkPhase('a');
            startDrinkPhase('b');

            requestAnimationFrame(gameLoop);
        }

        function getMeterSpeed(team) {
            const t = game.teams[team];
            let speed = game.config.baseMeterSpeed + (t.progress * game.config.meterSpeedIncrease);

            // Speed card doubles it
            if (t.challengeCard === 'speed') {
                speed *= 2;
            }

            return speed;
        }

        function startDrinkPhase(team) {
            const t = game.teams[team];
            if (t.eliminated) return;

            t.phase = 'drink';
            t.handRaised = false;
            t.attempts = 0;
            t.callout = null;
            t.challengeCard = null;
            t.reverseTimer = 0;

            // Reset challenge indicator
            document.getElementById(`challenge-${team}`).classList.add('hidden');
            document.getElementById(`callout-${team}`).style.display = 'none';

            updateStatus(team, 'DRINK & RAISE', 'drink');
            updateState(team, 'Raise hand when ready', '');
            updateAttempts(team, '');

            const cup = document.getElementById(`cup-${team}`);
            cup.className = 'cup';

            const meter = document.getElementById(`meter-${team}`);
            meter.style.display = 'none';
            meter.classList.remove('wobble', 'blindfold');

            document.getElementById(`result-${team}`).textContent = '';

            // Update zone sizes for shrinking
            updateZoneSizes(team);

            // Update flip counter display
            if (game.mode === 'speed' || game.mode === 'chaos') {
                document.getElementById(`flips-${team}`).textContent = `FLIPS: ${t.flips}`;
            } else if (game.mode === 'classic') {
                document.getElementById(`flips-${team}`).textContent = `${t.currentFlip}/${game.config.flipsPerPlayer}`;
            } else {
                document.getElementById(`flips-${team}`).textContent = '';
            }
        }

        function onHandRaised(team) {
            const t = game.teams[team];
            t.handRaised = true;
            updateState(team, 'READY!', 'raised');

            // Assign challenge card in chaos mode
            if (game.config.challengeCards) {
                const cardKey = cardKeys[Math.floor(Math.random() * cardKeys.length)];
                t.challengeCard = challengeCards[cardKey].effect;
                showChallengeCard(team, cardKey);

                // Wait for card reveal then show callout or start
                setTimeout(() => {
                    if (game.config.calloutSystem) {
                        showCalloutUI(team);
                    } else {
                        startFlipPhase(team);
                    }
                }, 2000);
            } else if (game.config.calloutSystem) {
                showCalloutUI(team);
            } else {
                startFlipPhase(team);
            }
        }

        function showCalloutUI(team) {
            // For now, auto-assign safe callout for simplicity
            // In full version, would show UI for that team
            game.teams[team].callout = 'safe';
            startFlipPhase(team);
        }

        function startFlipPhase(team) {
            const t = game.teams[team];
            t.phase = 'countdown';

            updateStatus(team, 'GET READY', '');
            updateState(team, '', '');

            document.getElementById(`cup-${team}`).className = 'cup on-edge';

            setTimeout(() => updateStatus(team, '3', ''), 400);
            setTimeout(() => updateStatus(team, '2', ''), 800);
            setTimeout(() => updateStatus(team, '1', ''), 1200);
            setTimeout(() => {
                t.phase = 'flip';
                t.meterPos = 50;
                t.meterDir = Math.random() > 0.5 ? 1 : -1;

                if (t.challengeCard === 'reverse') {
                    t.reverseTimer = 30 + Math.random() * 60;
                }

                updateStatus(team, 'FLICK!', 'ready');
                updateState(team, 'Flick UP now!', '');

                const meter = document.getElementById(`meter-${team}`);
                meter.style.display = 'block';

                // Apply challenge card effects
                if (t.challengeCard === 'blindfold') {
                    meter.classList.add('blindfold');
                }

                updateMeterWobble(team);

                const maxAttempts = t.challengeCard === 'pressure' ? 1 : game.config.maxAttempts;
                updateAttempts(team, `Attempt ${t.attempts + 1}/${maxAttempts}`);
            }, 1600);
        }

        function updateStatus(team, text, className) {
            const el = document.getElementById(`status-${team}`);
            el.textContent = text;
            el.className = 'status-message' + (className ? ` ${className}` : '');
        }

        function updateState(team, text, className) {
            const el = document.getElementById(`state-${team}`);
            el.textContent = text;
            el.className = 'player-state' + (className ? ` ${className}` : '');
        }

        function updateAttempts(team, text) {
            document.getElementById(`attempts-${team}`).textContent = text;
        }

        // ============ GAME LOOP ============
        function gameLoop() {
            if (!game.started) return;

            // Timer for speed/chaos modes
            if (game.mode === 'speed' || game.mode === 'chaos') {
                game.timeLeft = 60 - (Date.now() - game.startTime) / 1000;
                const timerEl = document.getElementById('mode-timer');
                timerEl.textContent = Math.ceil(Math.max(0, game.timeLeft));
                timerEl.className = game.timeLeft < 10 ? 'mode-timer warning' : 'mode-timer';

                document.getElementById('combo-display').textContent = game.globalCombo > 0 ? `${game.globalCombo}x COMBO` : '';

                if (game.timeLeft <= 0) {
                    endGame();
                    return;
                }
            }

            // Update meters
            ['a', 'b'].forEach(team => {
                const t = game.teams[team];
                if (t.phase === 'flip') {
                    const speed = getMeterSpeed(team);
                    t.meterPos += t.meterDir * speed;

                    // Reverse card - random direction changes
                    if (t.challengeCard === 'reverse') {
                        t.reverseTimer--;
                        if (t.reverseTimer <= 0) {
                            t.meterDir *= -1;
                            t.reverseTimer = 20 + Math.random() * 40;
                        }
                    }

                    if (t.meterPos >= 100) { t.meterPos = 100; t.meterDir = -1; }
                    if (t.meterPos <= 0) { t.meterPos = 0; t.meterDir = 1; }

                    document.getElementById(`needle-${team}`).style.left = t.meterPos + '%';
                }
            });

            requestAnimationFrame(gameLoop);
        }

        // ============ HAND DETECTION ============
        function onHandResults(results) {
            game.hands.left.visible = false;
            game.hands.right.visible = false;

            document.getElementById('hand-left').style.display = 'none';
            document.getElementById('hand-right').style.display = 'none';

            if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
                return;
            }

            results.multiHandLandmarks.forEach((landmarks, idx) => {
                const wrist = landmarks[0];
                const indexTip = landmarks[8];

                const side = wrist.x > 0.5 ? 'left' : 'right';
                const team = side === 'left' ? 'a' : 'b';

                const hand = game.hands[side];
                hand.visible = true;
                hand.x = (1 - wrist.x) * 360;
                hand.y = wrist.y * 270;

                const indicator = document.getElementById(`hand-${side}`);
                indicator.style.display = 'block';
                indicator.style.left = hand.x + 'px';
                indicator.style.top = hand.y + 'px';

                const isRaised = wrist.y < 0.35;
                const flickVelocity = (hand.lastY || wrist.y) - indexTip.y;
                const isFlicking = flickVelocity > 0.06;

                hand.lastY = indexTip.y;

                let gestureText = '';
                if (isRaised) gestureText = 'RAISED';
                else if (isFlicking) gestureText = 'FLICK!';
                document.getElementById(`gesture-${side}`).textContent = gestureText;

                const t = game.teams[team];
                if (t.eliminated) return;

                if (t.phase === 'drink' && isRaised && !t.handRaised) {
                    onHandRaised(team);
                }

                if (t.phase === 'flip' && isFlicking) {
                    handleFlip(team);
                }
            });
        }

        function handleFlip(team) {
            const t = game.teams[team];
            if (t.phase !== 'flip') return;

            t.phase = 'animating';
            t.attempts++;

            const pos = t.meterPos;
            let successChance;
            let zone;

            // Determine zone and success chance
            const shrinkFactor = game.config.shrinkingZones ? (1 - t.progress * game.config.shrinkFactor) : 1;
            const adjustedGreenMin = 50 - (15 * shrinkFactor);
            const adjustedGreenMax = 50 + (15 * shrinkFactor);
            const adjustedSweetMin = 50 - (2.5 * shrinkFactor);
            const adjustedSweetMax = 50 + (2.5 * shrinkFactor);

            if (pos >= adjustedSweetMin && pos <= adjustedSweetMax) {
                successChance = zoneConfig.sweetSpotChance;
                zone = 'sweet';
            } else if (pos >= adjustedGreenMin && pos <= adjustedGreenMax) {
                successChance = zoneConfig.greenChance;
                zone = 'green';
            } else if (pos >= zoneConfig.yellowMin && pos <= zoneConfig.yellowMax) {
                successChance = zoneConfig.yellowChance;
                zone = 'yellow';
            } else {
                successChance = zoneConfig.redChance;
                zone = 'red';
            }

            // Precision card - only sweet spot counts
            if (t.challengeCard === 'precision' && zone !== 'sweet') {
                successChance = 0;
            }

            const success = Math.random() < successChance;

            // Hide meter
            const meter = document.getElementById(`meter-${team}`);
            meter.style.display = 'none';
            meter.classList.remove('wobble', 'blindfold');

            const cup = document.getElementById(`cup-${team}`);
            const result = document.getElementById(`result-${team}`);

            if (success) {
                cup.className = 'cup flipped';
                result.textContent = 'LANDED!';
                result.className = 'result-flash success';

                // Confetti!
                const cupArea = cup.getBoundingClientRect();
                spawnConfetti(cupArea.left + cupArea.width/2, cupArea.top, zone === 'sweet' ? 50 : 30);

                // Determine feedback type
                if (t.attempts >= 4) {
                    showFeedback(team, 'clutch');
                } else if (zone === 'sweet') {
                    showFeedback(team, 'perfect');
                    if (t.callout === 'perfect') {
                        showDrinkingPrompt('perfectBonus');
                    }
                } else if (zone === 'green') {
                    showFeedback(team, 'clean');
                    if (t.callout === 'clean') {
                        showDrinkingPrompt('perfectBonus');
                    }
                } else if (zone === 'yellow') {
                    showFeedback(team, 'sloppy');
                } else {
                    showFeedback(team, 'lucky');
                    // Lucky bastard rule - other team drinks!
                    if (game.mode === 'chaos') {
                        showDrinkingPrompt('luckyBastard');
                    }
                }

                // Check wrong callout
                if (t.callout === 'perfect' && zone !== 'sweet') {
                    setTimeout(() => showDrinkingPrompt('wrongCallout'), 1500);
                } else if (t.callout === 'clean' && zone !== 'green' && zone !== 'sweet') {
                    setTimeout(() => showDrinkingPrompt('wrongCallout'), 1500);
                }

                t.flips++;
                t.combo++;
                if (t.combo > t.bestCombo) t.bestCombo = t.combo;

                if (game.mode === 'speed' || game.mode === 'chaos') {
                    game.globalCombo++;
                    if (game.globalCombo > game.globalBestCombo) game.globalBestCombo = game.globalCombo;
                }

                setTimeout(() => progressPlayer(team), 1200);
            } else {
                cup.className = 'cup fallen';
                result.textContent = 'MISS!';
                result.className = 'result-flash fail';

                // Screen shake on miss
                triggerScreenShake(false);

                // Combo breaker
                if (t.combo >= 3) {
                    showDrinkingPrompt('comboBreaker');
                }

                t.combo = 0;
                if (game.mode === 'speed' || game.mode === 'chaos') game.globalCombo = 0;

                // Feedback based on zone
                if (zone === 'green' || zone === 'sweet') {
                    showFeedback(team, 'choke');
                    if (game.mode === 'chaos') {
                        showDrinkingPrompt('chokeTax');
                    }
                } else if (t.attempts >= 3) {
                    showFeedback(team, 'pathetic');
                    triggerGlitch();
                    triggerScreenShake(true);
                    if (game.mode === 'chaos') {
                        showDrinkingPrompt('patheticTax');
                    }
                }

                // Check for sudden death or pressure card elimination
                const maxAttempts = t.challengeCard === 'pressure' ? 1 : game.config.maxAttempts;

                if (game.mode === 'sudden' || t.challengeCard === 'pressure') {
                    setTimeout(() => eliminatePlayer(team), 1000);
                    return;
                }

                // Check mercy rule
                if (t.attempts >= maxAttempts) {
                    setTimeout(() => {
                        result.textContent = 'MERCY!';
                        cup.className = 'cup flipped';
                        showFeedback(team, 'pathetic');
                        triggerScreenShake(true);
                        if (game.mode === 'chaos') {
                            showDrinkingPrompt('mercyShame');
                        }
                        t.flips++;
                        setTimeout(() => progressPlayer(team), 800);
                    }, 800);
                } else {
                    setTimeout(() => {
                        cup.className = 'cup on-edge';
                        result.textContent = '';
                        t.phase = 'flip';
                        t.meterPos = 50;
                        t.meterDir = Math.random() > 0.5 ? 1 : -1;

                        const meter = document.getElementById(`meter-${team}`);
                        meter.style.display = 'block';

                        if (t.challengeCard === 'blindfold') {
                            meter.classList.add('blindfold');
                        }
                        updateMeterWobble(team);

                        updateAttempts(team, `Attempt ${t.attempts + 1}/${maxAttempts}`);
                    }, 1000);
                }
            }
        }

        function progressPlayer(team) {
            const t = game.teams[team];
            const count = team === 'a' ? game.teamACount : game.teamBCount;

            t.currentFlip++;
            game.roundNumber++;

            // Speed/Chaos mode - just keep flipping
            if (game.mode === 'speed' || game.mode === 'chaos') {
                document.getElementById(`flips-${team}`).textContent = `FLIPS: ${t.flips}`;
                setTimeout(() => startDrinkPhase(team), 500);
                return;
            }

            // Classic mode - check if player completed their flips
            if (game.mode === 'classic') {
                if (t.currentFlip >= game.config.flipsPerPlayer) {
                    document.getElementById(`dot-${team}-${t.progress}`).classList.remove('active');
                    document.getElementById(`dot-${team}-${t.progress}`).classList.add('done');
                    t.progress++;
                    t.currentFlip = 0;

                    if (t.progress >= count) {
                        endGame(team);
                        return;
                    }

                    document.getElementById(`dot-${team}-${t.progress}`).classList.add('active');
                }

                setTimeout(() => startDrinkPhase(team), 800);
                return;
            }

            // Sudden death mode
            if (game.mode === 'sudden') {
                document.getElementById(`dot-${team}-${t.progress}`).classList.remove('active');
                document.getElementById(`dot-${team}-${t.progress}`).classList.add('done');
                t.progress++;

                if (t.progress >= count) {
                    endGame(team);
                    return;
                }

                document.getElementById(`dot-${team}-${t.progress}`).classList.add('active');
                setTimeout(() => startDrinkPhase(team), 800);
            }
        }

        function eliminatePlayer(team) {
            const t = game.teams[team];
            const count = team === 'a' ? game.teamACount : game.teamBCount;

            document.getElementById(`dot-${team}-${t.progress}`).classList.remove('active');
            document.getElementById(`dot-${team}-${t.progress}`).classList.add('eliminated');

            t.progress++;

            if (t.progress >= count) {
                t.eliminated = true;
                updateStatus(team, 'ELIMINATED', '');
                const otherTeam = team === 'a' ? 'b' : 'a';

                if (game.teams[otherTeam].eliminated) {
                    endGame();
                } else {
                    const otherCount = otherTeam === 'a' ? game.teamACount : game.teamBCount;
                    if (game.teams[otherTeam].progress >= otherCount) {
                        endGame(otherTeam);
                    }
                }
                return;
            }

            document.getElementById(`dot-${team}-${t.progress}`).classList.add('active');
            setTimeout(() => startDrinkPhase(team), 800);
        }

        function endGame(winner) {
            game.started = false;

            const winScreen = document.getElementById('win-screen');
            const winnerText = document.getElementById('winner-text');
            const loserText = document.getElementById('loser-text');

            if (game.mode === 'speed' || game.mode === 'chaos') {
                const aFlips = game.teams.a.flips;
                const bFlips = game.teams.b.flips;

                if (aFlips > bFlips) {
                    winnerText.textContent = 'TEAM A WINS!';
                    winnerText.className = 'winner-text team-a';
                    loserText.textContent = `${aFlips} vs ${bFlips} FLIPS`;
                } else if (bFlips > aFlips) {
                    winnerText.textContent = 'TEAM B WINS!';
                    winnerText.className = 'winner-text team-b';
                    loserText.textContent = `${bFlips} vs ${aFlips} FLIPS`;
                } else {
                    winnerText.textContent = 'TIE GAME!';
                    winnerText.className = 'winner-text';
                    loserText.textContent = `BOTH GOT ${aFlips} FLIPS`;
                }

                document.getElementById('stat-flips').textContent = aFlips + bFlips;
                document.getElementById('stat-combo').textContent = game.globalBestCombo;
            } else if (winner) {
                winnerText.textContent = winner === 'a' ? 'TEAM A WINS!' : 'TEAM B WINS!';
                winnerText.className = 'winner-text team-' + winner;
                loserText.textContent = game.mode === 'sudden' ? 'SURVIVORS!' : 'LOSERS DRINK!';

                document.getElementById('stat-flips').textContent = game.teams.a.flips + game.teams.b.flips;
                document.getElementById('stat-combo').textContent = Math.max(game.teams.a.bestCombo, game.teams.b.bestCombo);
            }

            document.getElementById('stat-drinks').textContent = game.totalDrinks;
            winScreen.style.display = 'flex';
        }

        function resetGame() {
            document.getElementById('win-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('setup-screen').style.display = 'flex';
            document.getElementById('mode-timer').classList.add('hidden');
            document.getElementById('combo-display').classList.add('hidden');
            document.getElementById('callout-ui').style.display = 'none';

            game.started = false;
        }

        // ============ MEDIAPIPE SETUP ============
        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({
            maxNumHands: 2,
            modelComplexity: 0,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        hands.onResults(onHandResults);

        async function setup() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480, facingMode: 'user' }
                });
                video.srcObject = stream;
                previewVideo.srcObject = stream;
                await new Promise(r => { video.onloadedmetadata = () => { video.play(); r(); }; });
                previewVideo.play();

                const cam = new Camera(video, {
                    onFrame: async () => {
                        await hands.send({ image: video });
                    },
                    width: 640,
                    height: 480
                });
                await cam.start();

                document.getElementById('loading').classList.add('hidden');
            } catch (e) {
                document.getElementById('loading').textContent = 'CAMERA ERROR: ' + e.message;
            }
        }

        setup();
    </script>
</body>
</html>
